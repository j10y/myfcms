Ext.ns("MailView");var MailView=function(){};MailView.prototype.getView=function(){return new Ext.Panel({id:"MailView",title:"[收件箱]",autoScroll:true,border:false,layout:"border",items:[new Ext.FormPanel({height:40,region:"north",frame:false,id:"MailSearchForm",layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{xtype:"label",margins:{top:0,right:4,bottom:4,left:4}},items:[{text:"查询条件:"},{text:"邮件标题"},{width:140,xtype:"textfield",name:"Q_mail.subject_S_LK"},{text:"发件人"},{width:80,xtype:"textfield",name:"Q_mail.sender_S_LK"},{text:"收件人"},{width:80,xtype:"textfield",name:"Q_appUser.fullname_S_LK"},{xtype:"button",text:"查询",iconCls:"search",handler:function(){var a=Ext.getCmp("MailSearchForm");var b=Ext.getCmp("MailGrid");if(a.getForm().isValid()){a.getForm().submit({waitMsg:"正在提交查询",url:__ctxPath+"/communicate/listMail.do",success:function(d,e){var c=Ext.util.JSON.decode(e.response.responseText);b.getStore().loadData(c);}});}}}]}),this.setup()]});};MailView.prototype.setFolderId=function(a){this.folderId=a;MailView.folderId=a;};MailView.prototype.getFolderId=function(){return this.folderId;};MailView.prototype.setup=function(){return this.grid();};MailView.prototype.grid=function(){var e=new Ext.ux.grid.RowExpander({tpl:new Ext.Template('<div style="padding:5px 5px 5px 62px;"><b>内容摘要:</b> {content}</div>')});var d=new Ext.grid.CheckboxSelectionModel();var a=new Ext.grid.ColumnModel({columns:[d,new Ext.grid.RowNumberer(),e,{header:"mailId",dataIndex:"mailId",hidden:true},{header:"优先级",dataIndex:"importantFlag",width:55,renderer:function(i,h,f,k,g){var j="";if(i==2){j+='<img title="重要" src="'+__ctxPath+'/images/flag/mail/important.png"/>';}else{if(i==3){j+='<img title="非常重要" src="'+__ctxPath+'/images/flag/mail/veryImportant.png"/>';}else{j+='<img title="一般" src="'+__ctxPath+'/images/flag/mail/common.png"/>';}}return j;}},{header:"阅读",dataIndex:"mailStatus",width:40,renderer:function(i,h,f,k,g){var j="";if(i!=0){if(f.data.readFlag==0){j+='<img title="未读" src="'+__ctxPath+'/images/flag/mail/mail.png"/>';}else{j+='<img title="已读" src="'+__ctxPath+'/images/flag/mail/mail_open.png"/>';}}else{j+='<img title="草稿" src="'+__ctxPath+'/images/flag/mail/mail_draft.png"/>';}return j;}},{header:"附件",dataIndex:"fileIds",width:40,renderer:function(i,h,f,k,g){var j="";if(i!=""){j+='<img title="附件" src="'+__ctxPath+'/images/flag/attachment.png"/>';}return j;}},{header:"回复",dataIndex:"replyFlag",width:40,renderer:function(i,h,f,k,g){var j="";if(i==1){j+='<img title="已回复" src="'+__ctxPath+'/images/flag/mail/replyed.png" style="background: white;"/>';}return j;}},{header:"邮件主题",dataIndex:"subject",width:150},{header:"发件人",dataIndex:"sender",width:80},{header:"收件人",dataIndex:"recipientNames",width:80,renderer:function(f){if(f!=""){return f;}else{return"(收信人未写)";}}},{header:"发信时间",width:80,dataIndex:"sendTime",renderer:function(f){return f.substring(0,10);}},{header:"管理",dataIndex:"mailId",width:60,renderer:function(m,l,i,k,o){var f=MailView.folderId;var h=m;var n=i.data.boxId;var g=i.data.mailStatus;var j='<button title="删除" value=" " class="btn-del" onclick="MailView.remove('+n+","+f+')">&nbsp</button>';j+='&nbsp;<button title="查看" value=" " class="btn-mail_edit" onclick="MailView.edit('+h+","+n+","+f+","+g+","+k+')">&nbsp</button>';return j;}}],defaults:{sortable:true,menuDisabled:false,width:100}});var b=this.store();b.load({params:{start:0,limit:25}});var c=new Ext.grid.GridPanel({id:"MailGrid",region:"center",autoHeight:true,tbar:this.topbar(),store:b,plugins:e,trackMouseOver:true,disableSelection:false,loadMask:true,stripeRows:true,cm:a,sm:d,viewConfig:{forceFit:true,autoFill:true,forceFit:true},bbar:new Ext.PagingToolbar({pageSize:25,store:b,displayInfo:true,displayMsg:"当前显示从{0}至{1}， 共{2}条记录",emptyMsg:"当前没有记录"})});c.addListener("rowdblclick",function(f,h,g){f.getSelectionModel().each(function(j){var i=MailView.folderId;MailView.edit(j.data.mailId,j.data.boxId,i,j.data.mailStatus,h);});});return c;};MailView.prototype.store=function(){var a=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/communicate/listMail.do"}),reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"boxId",type:"int"},{name:"mailId",type:"int"},{name:"delFlag",type:"int"},{name:"readFlag",type:"int"},{name:"replyFlag",type:"int"},"importantFlag","mailStatus","sendTime","fileIds","subject","recipientNames","content","sender"]}),remoteSort:true});a.setDefaultSort("boxId","desc");return a;};MailView.prototype.topbar=function(){var a=new Ext.Toolbar({id:"MailFootBar",height:30,bodyStyle:"text-align:left",items:[{iconCls:"btn-mail_remove",text:"删除",xtype:"button",handler:function(){var e=Ext.getCmp("MailGrid");var b=e.getSelectionModel().getSelections();if(b.length==0){Ext.ux.Toast.msg("信息","请选择要删除的记录！");return;}var f=Array();for(var d=0;d<b.length;d++){f.push(b[d].data.boxId);}var c=MailView.folderId;MailView.remove(f,c);}},{iconCls:"btn-mail_move",text:"移至",handler:function(){var d=Ext.getCmp("MailGrid");var b=d.getSelectionModel().getSelections();if(b.length==0){Ext.ux.Toast.msg("信息","请选择要移动的邮件！");return;}var e=Array();for(var c=0;c<b.length;c++){e.push(b[c].data.boxId);}MailView.moveTo(e);}},{iconCls:"btn-mail_refresh",text:"刷新",handler:function(){Ext.getCmp("MailGrid").getStore().reload({params:{start:0,limit:25}});}}]});return a;};MailView.remove=function(c,a){if(a==null||a=="undefined"){a=1;}var b=Ext.getCmp("MailGrid");var d="";if(a==4){d="删除箱的记录一旦删除,将不可恢复!";}Ext.Msg.confirm("信息确认",d+"您确认要删除该记录吗？",function(f){if(f=="yes"){Ext.Ajax.request({url:__ctxPath+"/communicate/multiDelMail.do",params:{ids:c,folderId:a},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");b.getStore().reload({params:{start:0,limit:25}});}});var e=Ext.getCmp("MailCenterView");e.remove("ShowMailDetail");var g=Ext.getCmp("MailView");g.show();e.doLayout();}});};MailView.edit=function(d,k,a,e,h){var f=new MailView.centerViewToolbar(d,k,a,h);if(e==0){var c=Ext.getCmp("centerTabPanel");var b=Ext.getCmp("MailForm");if(b==null){b=new MailForm(d,k,"draft");c.add(b);c.activate(b);}else{c.remove(b);b=new MailForm(d,k,"draft");c.add(b);c.activate(b);}}else{var i=Ext.getCmp("MailCenterView");var j=Ext.getCmp("MailView");j.hide();var g=new Ext.Panel({id:"ShowMailDetail",title:"[邮件信息]",border:false,tbar:f,autoLoad:{url:__ctxPath+"/communicate/getMail.do?",params:{mailId:d,boxId:k},method:"Post"}});i.add(g);i.doLayout();}};MailView.centerViewToolbar=function(b,d,a,e){var c=new Ext.Toolbar({height:30,defaultType:"button",bodyStyle:"text-align:left",items:[{iconCls:"btn-mail_back",text:"返回",handler:function(){var f=Ext.getCmp("MailCenterView");f.remove("ShowMailDetail");var g=Ext.getCmp("MailView");g.show();f.doLayout();}},{iconCls:"btn-mail_reply",text:"回复",handler:function(){var f=Ext.getCmp("centerTabPanel");var g=Ext.getCmp("MailForm");if(g==null){g=new MailForm(b,d,"reply");f.add(g);f.activate(g);}else{f.remove(g);g=new MailForm(b,d,"reply");f.add(g);f.activate(g);}}},{iconCls:"btn-mail_resend",text:"转发",handler:function(){var f=Ext.getCmp("centerTabPanel");var g=Ext.getCmp("MailForm");if(g==null){g=new MailForm(b,d,"forward");f.add(g);f.activate(g);}else{f.remove(g);g=new MailForm(b,d,"forward");f.add(g);f.activate(g);}}},{iconCls:"btn-mail_remove",text:"删除",handler:function(){MailView.remove(d,a);}},{iconCls:"btn-mail_move",text:"移至",handler:function(){MailView.moveTo(d);}},"->",{iconCls:"btn-up",text:"较旧一封",handler:function(){var f=document.getElementById("__haveNextMailFlag");if(f!=null&&f.value!="endPre"){var g=curUserInfo.userId;var h=document.getElementById("__curBoxId").value;Ext.getCmp("ShowMailDetail").load({url:__ctxPath+"/communicate/getMail.do?",params:{boxId:h,opt:"_pre",folderId:a},method:"Post"});}else{Ext.ux.Toast.msg("提示信息","这里已经是第一封邮件了");}}},{iconCls:"btn-last",text:"较新一封",handler:function(){var f=document.getElementById("__haveNextMailFlag");if(f!=null&&f.value!="endNext"){var g=curUserInfo.userId;var h=document.getElementById("__curBoxId").value;Ext.getCmp("ShowMailDetail").load({url:__ctxPath+"/communicate/getMail.do?",params:{boxId:h,opt:"_next",folderId:a},method:"Post"});}else{Ext.ux.Toast.msg("提示信息","这里已经是最后一封邮件了");}}}]});return c;};MailView.moveTo=function(c){var b=new MailView.moveFormPanel(c);var a=new Ext.Window({x:350,y:100,width:340,height:300,title:"移动邮件",iconCls:"btn-mail_move",modal:true,buttonAlign:"center",plain:true,layout:"fit",border:false,bodyStyle:"padding:5px;",items:[b],buttons:[{text:"确定移动",iconCls:"btn-mail_move",handler:function(){var d=Ext.getCmp("folderId");if(d==""&&d!=null&&d!="undefined"){Ext.ux.Toast.msg("操作信息","请先选择文件夹");}else{var e=Ext.getCmp("moveFolderForm");e.getForm().submit({waitMsg:"正在提交用户信息",success:function(h,i){Ext.ux.Toast.msg("操作信息","移动成功！");a.close();var f=Ext.getCmp("MailCenterView");f.remove("ShowMailDetail");var g=Ext.getCmp("MailView");Ext.getCmp("MailGrid").getStore().reload({params:{start:0,limit:25}});g.show();f.doLayout();},failure:function(f,g){Ext.ux.Toast.msg("提示信息",g.result.msg);}});}}},{text:"取消",iconCls:"btn-del",handler:function(){a.close();}}]});a.show();};MailView.moveFormPanel=function(b){var c=new Ext.tree.TreePanel({title:"请选择文件夹",loader:new Ext.tree.TreeLoader({url:__ctxPath+"/communicate/listMailFolder.do"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{"click":function(d){if(d!=null&&d.id!=0){Ext.getCmp("dispalyFolderName").setValue(d.text);Ext.getCmp("folderId").setValue(d.id);}}}});var a=new Ext.FormPanel({url:__ctxPath+"/communicate/moveMail.do",layout:"table",id:"moveFolderForm",frame:true,defaultType:"textfield",layoutConfig:{columns:1},defaults:{width:296},items:[{xtype:"label",text:"移至:"},{id:"dispalyFolderName",readOnly:true},{xtype:"hidden",id:"folderId",name:"folderId"},{id:"boxIds",name:"boxIds",xtype:"hidden",value:b},{xtype:"panel",items:[c]}]});return a;};