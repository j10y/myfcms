var FCKDragTableHandler={"_DragState":0,"_LeftCell":null,"_RightCell":null,"_MouseMoveMode":0,"_ResizeBar":null,"_OriginalX":null,"_MinimumX":null,"_MaximumX":null,"_LastX":null,"_TableMap":null,"_doc":document,"_IsInsideNode":function(b,d,h){var f=FCKTools.GetWindowPosition(b,d);var c=f.x;var a=f.y;var g=parseInt(c,10)+parseInt(d.offsetWidth,10);var e=parseInt(a,10)+parseInt(d.offsetHeight,10);if(h.x>=c&&h.x<=g&&h.y>=a&&h.y<=e){return true;}return false;},"_GetBorderCells":function(l,v,p,m){var e=[];for(var t=0;t<v.rows.length;t++){var q=v.rows[t];for(var s=0;s<q.cells.length;s++){e.push(q.cells[s]);}}if(e.length<1){return null;}var c=null;var d=null;var k=null;var u=null;var a=null;for(var t=0;t<e.length;t++){var g=FCKTools.GetWindowPosition(l,e[t]);var f=g.x+parseInt(e[t].clientWidth,10);var x=m.x-f;var o=m.y-(g.y+(e[t].clientHeight/2));if(c==null||(Math.abs(x)<=Math.abs(c)&&(k==null||Math.abs(o)<=Math.abs(k)))){c=x;k=o;u=e[t];}}var b=u.parentNode.rowIndex;var n=FCKTableHandler._GetCellIndexSpan(p,b,u);var h=isNaN(u.colSpan)?1:u.colSpan;a=p[b][n+h];if(!a){return null;}d=m.x-FCKTools.GetWindowPosition(l,a).x;if(d<0&&c<0&&c<-2){return null;}if(d>0&&c>0&&d>3){return null;}return{"leftCell":u,"rightCell":a};},"_GetResizeBarPosition":function(){var a=FCKTools.GetElementAscensor(this._RightCell,"tr");return FCKTableHandler._GetCellIndexSpan(this._TableMap,a.rowIndex,this._RightCell);},"_ResizeBarMouseDownListener":function(l){if(FCKDragTableHandler._LeftCell){FCKDragTableHandler._MouseMoveMode=1;}if(FCKBrowserInfo.IsIE){FCKDragTableHandler._ResizeBar.filters.item("DXImageTransform.Microsoft.Alpha").opacity=50;}else{FCKDragTableHandler._ResizeBar.style.opacity=0.5;}FCKDragTableHandler._OriginalX=l.clientX;var j=FCKDragTableHandler._GetResizeBarPosition();var f=FCKDragTableHandler._GetIframeOffset();var m=FCKTools.GetElementAscensor(FCKDragTableHandler._LeftCell,"table");var d=null;var c=null;for(var a=0;a<FCKDragTableHandler._TableMap.length;a++){var k=FCKDragTableHandler._TableMap[a][j-1];var g=FCKDragTableHandler._TableMap[a][j];var i=FCKTools.GetWindowPosition(FCK.EditorWindow,k);var h=FCKTools.GetWindowPosition(FCK.EditorWindow,g);var b=FCKDragTableHandler._GetCellPadding(m,k);var e=FCKDragTableHandler._GetCellPadding(m,g);if(d==null||i.x+b>d){d=i.x+b;}if(c==null||h.x+g.clientWidth-e<c){c=h.x+g.clientWidth-e;}}FCKDragTableHandler._MinimumX=d+f.x;FCKDragTableHandler._MaximumX=c+f.x;FCKDragTableHandler._LastX=null;if(l.preventDefault){l.preventDefault();}else{l.returnValue=false;}},"_ResizeBarMouseUpListener":function(n){FCKDragTableHandler._MouseMoveMode=0;FCKDragTableHandler._HideResizeBar();if(FCKDragTableHandler._LastX==null){return;}var f=FCKDragTableHandler._LastX-FCKDragTableHandler._OriginalX;var s=FCKTools.GetElementAscensor(FCKDragTableHandler._LeftCell,"table");var q=[];var d=FCKDragTableHandler._TableMap;for(var k=0;k<d.length;k++){for(var e=0;e<d[k].length;e++){var o=d[k][e];var b=FCKDragTableHandler._GetCellWidth(s,o);var l=isNaN(o.colSpan)?1:o.colSpan;if(q.length<=e){q.push({width:b/l,colSpan:l});}else{var p=q[e];if(p.colSpan>l){p.width=b/l;p.colSpan=l;}}}}colIndex=FCKDragTableHandler._GetResizeBarPosition();colIndex--;q[colIndex].width+=f;q[colIndex+1].width-=f;for(var a=0;a<s.rows.length;a++){var t=s.rows.item(a);for(var m=0;m<t.cells.length;m++){var o=t.cells.item(m);o.width="";o.style.width="";}}var h=s.getElementsByTagName("col");for(var k=h.length-1;k>=0;k--){h[k].parentNode.removeChild(h[k]);}var g=[];for(var k=0;k<d.length;k++){for(var e=0;e<d[k].length;e++){var o=d[k][e];if(o._Processed){continue;}if(d[k][e-1]!=o){o.width=q[e].width;}else{o.width=parseInt(o.width,10)+parseInt(q[e].width,10);}if(d[k][e+1]!=o){g.push(o);o._Processed=true;}}}for(var k=0;k<g.length;k++){if(FCKBrowserInfo.IsIE){g[k].removeAttribute("_Processed");}else{delete g[k]._Processed;}}FCKDragTableHandler._LastX=null;},"_ResizeBarMouseMoveListener":function(a){if(FCKDragTableHandler._MouseMoveMode==0){return FCKDragTableHandler._MouseFindHandler(FCK,a);}else{return FCKDragTableHandler._MouseDragHandler(FCK,a);}},"_GetCellPadding":function(e,b){var a=parseInt(e.cellPadding,10)*2;var c=null;if(typeof(window.getComputedStyle)=="function"){var f=window.getComputedStyle(b,null);c=parseInt(f.getPropertyValue("padding-left"),10)+parseInt(f.getPropertyValue("padding-right"),10);}else{c=parseInt(b.currentStyle.paddingLeft,10)+parseInt(b.currentStyle.paddingRight,10);}var d=b.style.padding;if(isFinite(d)){c=parseInt(d,10)*2;}else{d=b.style.paddingLeft;if(isFinite(d)){c=parseInt(d,10);}d=b.style.paddingRight;if(isFinite(d)){c+=parseInt(d,10);}}a=parseInt(a,10);c=parseInt(c,10);if(isNaN(a)){a=0;}if(isNaN(c)){c=0;}return Math.max(a,c);},"_GetCellWidth":function(b,a){var c=a.clientWidth;if(isNaN(c)){c=0;}return c-this._GetCellPadding(b,a);},"MouseMoveListener":function(b,a){if(FCKDragTableHandler._MouseMoveMode==0){return FCKDragTableHandler._MouseFindHandler(b,a);}else{return FCKDragTableHandler._MouseDragHandler(b,a);}},"_MouseFindHandler":function(m,o){if(m.MouseDownFlag){return;}var d=o.srcElement||o.target;try{if(!d||d.nodeType!=1){this._HideResizeBar();return;}}catch(l){this._HideResizeBar();return;}var g=o.clientX;var f=o.clientY;if(FCKTools.GetElementDocument(d)==document){var i=this._GetIframeOffset();g-=i.x;f-=i.y;}if(this._ResizeBar&&this._LeftCell){var h=FCKTools.GetWindowPosition(m.EditorWindow,this._LeftCell);var k=FCKTools.GetWindowPosition(m.EditorWindow,this._RightCell);var j=g-(h.x+this._LeftCell.clientWidth);var n=g-k.x;var c=false;if(n>=0&&j<=0){c=true;}else{if(j>0&&n<=3){c=true;}else{if(n<0&&j>=-2){c=true;}}}if(c){this._ShowResizeBar(m.EditorWindow,FCKTools.GetElementAscensor(this._LeftCell,"table"),{"x":g,"y":f});return;}}var b=d.tagName.toLowerCase();if(b!="table"&&b!="td"&&b!="th"){if(this._LeftCell){this._LeftCell=this._RightCell=this._TableMap=null;}this._HideResizeBar();return;}d=FCKTools.GetElementAscensor(d,"table");var a=FCKTableHandler._CreateTableMap(d);var p=this._GetBorderCells(m.EditorWindow,d,a,{"x":g,"y":f});if(p==null){if(this._LeftCell){this._LeftCell=this._RightCell=this._TableMap=null;}this._HideResizeBar();}else{this._LeftCell=p["leftCell"];this._RightCell=p["rightCell"];this._TableMap=a;this._ShowResizeBar(m.EditorWindow,FCKTools.GetElementAscensor(this._LeftCell,"table"),{"x":g,"y":f});}},"_MouseDragHandler":function(f,a){var c={"x":a.clientX,"y":a.clientY};var d=a.srcElement||a.target;if(FCKTools.GetElementDocument(d)==f.EditorDocument){var e=this._GetIframeOffset();c.x+=e.x;c.y+=e.y;}if(c.x>=this._MaximumX-5){c.x=this._MaximumX-5;}if(c.x<=this._MinimumX+5){c.x=this._MinimumX+5;}var b=c.x+FCKTools.GetScrollPosition(window).X;this._ResizeBar.style.left=(b-this._ResizeBar.offsetWidth/2)+"px";this._LastX=c.x;},"_ShowResizeBar":function(k,n,g){if(this._ResizeBar==null){this._ResizeBar=this._doc.createElement("div");var j=this._ResizeBar;var b={"position":"absolute","cursor":"e-resize"};if(FCKBrowserInfo.IsIE){b.filter="progid:DXImageTransform.Microsoft.Alpha(opacity=10,enabled=true)";}else{b.opacity=0.1;}FCKDomTools.SetElementStyles(j,b);this._avoidStyles(j);j.setAttribute("_fcktemp",true);this._doc.body.appendChild(j);FCKTools.AddEventListener(j,"mousemove",this._ResizeBarMouseMoveListener);FCKTools.AddEventListener(j,"mousedown",this._ResizeBarMouseDownListener);FCKTools.AddEventListener(document,"mouseup",this._ResizeBarMouseUpListener);FCKTools.AddEventListener(FCK.EditorDocument,"mouseup",this._ResizeBarMouseUpListener);var d=this._doc.createElement("img");d.setAttribute("_fcktemp",true);d.border=0;d.src=FCKConfig.BasePath+"images/spacer.gif";d.style.position="absolute";j.appendChild(d);var e=function(p){if(p.preventDefault){p.preventDefault();}else{p.returnValue=false;}};FCKTools.AddEventListener(d,"dragstart",e);FCKTools.AddEventListener(d,"selectstart",e);}var j=this._ResizeBar;var c=this._GetIframeOffset();var l=this._GetTablePosition(k,n);var m=n.offsetHeight;var h=c.y+l.y;if(l.y<0){m+=l.y;h-=l.y;}var i=parseInt(n.border,10);if(isNaN(i)){i=0;}var f=parseInt(n.cellSpacing,10);if(isNaN(f)){f=0;}var o=Math.max(i+100,f+100);var b={"top":h+"px","height":m+"px","width":o+"px","left":(c.x+g.x+FCKTools.GetScrollPosition(k).X-o/2)+"px"};if(FCKBrowserInfo.IsIE){j.filters.item("DXImageTransform.Microsoft.Alpha").opacity=10;}else{b.opacity=0.1;}FCKDomTools.SetElementStyles(j,b);var d=j.getElementsByTagName("img")[0];FCKDomTools.SetElementStyles(d,{width:j.offsetWidth+"px",height:m+"px"});o=Math.max(i,f,3);var a=null;if(j.getElementsByTagName("div").length<1){a=this._doc.createElement("div");this._avoidStyles(a);a.setAttribute("_fcktemp",true);j.appendChild(a);}else{a=j.getElementsByTagName("div")[0];}FCKDomTools.SetElementStyles(a,{position:"absolute",backgroundColor:"blue",width:o+"px",height:m+"px",left:"50px",top:"0px"});},"_HideResizeBar":function(){if(this._ResizeBar){FCKDomTools.SetElementStyles(this._ResizeBar,{top:"-100000px",left:"-100000px"});}},"_GetIframeOffset":function(){return FCKTools.GetDocumentPosition(window,FCK.EditingArea.IFrame);},"_GetTablePosition":function(a,b){return FCKTools.GetWindowPosition(a,b);},"_avoidStyles":function(a){FCKDomTools.SetElementStyles(a,{padding:"0",backgroundImage:"none",border:"0"});},"Reset":function(){FCKDragTableHandler._LeftCell=FCKDragTableHandler._RightCell=FCKDragTableHandler._TableMap=null;}};FCK.Events.AttachEvent("OnMouseMove",FCKDragTableHandler.MouseMoveListener);FCK.Events.AttachEvent("OnAfterSetHTML",FCKDragTableHandler.Reset);