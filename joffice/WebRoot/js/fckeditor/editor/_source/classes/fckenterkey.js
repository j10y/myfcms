var FCKEnterKey=function(b,a,e,c){this.Window=b;this.EnterMode=a||"p";this.ShiftEnterMode=e||"br";var d=new FCKKeystrokeHandler(false);d._EnterKey=this;d.OnKeystroke=FCKEnterKey_OnKeystroke;d.SetKeystrokes([[13,"Enter"],[SHIFT+13,"ShiftEnter"],[8,"Backspace"],[CTRL+8,"CtrlBackspace"],[46,"Delete"]]);this.TabText="";if(c>0||FCKBrowserInfo.IsSafari){while(c--){this.TabText+="\xa0";}d.SetKeystrokes([9,"Tab"]);}d.AttachToElement(b.document);};function FCKEnterKey_OnKeystroke(a,d){var b=this._EnterKey;try{switch(d){case"Enter":return b.DoEnter();break;case"ShiftEnter":return b.DoShiftEnter();break;case"Backspace":return b.DoBackspace();break;case"Delete":return b.DoDelete();break;case"Tab":return b.DoTab();break;case"CtrlBackspace":return b.DoCtrlBackspace();break;}}catch(c){}return false;}FCKEnterKey.prototype.DoEnter=function(e,d){FCKUndo.SaveUndoStep();this._HasShift=(d===true);var a=FCKSelection.GetParentElement();var b=new FCKElementPath(a);var c=e||this.EnterMode;if(c=="br"||b.Block&&b.Block.tagName.toLowerCase()=="pre"){return this._ExecuteEnterBr();}else{return this._ExecuteEnterBlock(c);}};FCKEnterKey.prototype.DoShiftEnter=function(){return this.DoEnter(this.ShiftEnterMode,true);};FCKEnterKey.prototype.DoBackspace=function(){var g=false;var d=new FCKDomRange(this.Window);d.MoveToSelection();if(FCKBrowserInfo.IsIE&&this._CheckIsAllContentsIncluded(d,this.Window.document.body)){this._FixIESelectAllBug(d);return true;}var k=d.CheckIsCollapsed();if(!k){if(FCKBrowserInfo.IsIE&&this.Window.document.selection.type.toLowerCase()=="control"){var m=this.Window.document.selection.createRange();for(var j=m.length-1;j>=0;j--){var b=m.item(j);b.parentNode.removeChild(b);}return true;}return false;}if(FCKBrowserInfo.IsIE){var f=FCKDomTools.GetPreviousSourceElement(d.StartNode,true);if(f&&f.nodeName.toLowerCase()=="br"){var e=d.Clone();e.SetStart(f,4);if(e.CheckIsEmpty()){f.parentNode.removeChild(f);return true;}}}var h=d.StartBlock;var a=d.EndBlock;if(d.StartBlockLimit==d.EndBlockLimit&&h&&a){if(!k){var l=d.CheckEndOfBlock();d.DeleteContents();if(h!=a){d.SetStart(a,1);d.SetEnd(a,1);}d.Select();g=(h==a);}if(d.CheckStartOfBlock()){var c=d.StartBlock;var n=FCKDomTools.GetPreviousSourceElement(c,true,["BODY",d.StartBlockLimit.nodeName],["UL","OL"]);g=this._ExecuteBackspace(d,n,c);}else{if(FCKBrowserInfo.IsGeckoLike){d.Select();}}}d.Release();return g;};FCKEnterKey.prototype.DoCtrlBackspace=function(){FCKUndo.SaveUndoStep();var a=new FCKDomRange(this.Window);a.MoveToSelection();if(FCKBrowserInfo.IsIE&&this._CheckIsAllContentsIncluded(a,this.Window.document.body)){this._FixIESelectAllBug(a);return true;}return false;};FCKEnterKey.prototype._ExecuteBackspace=function(h,i,e){var f=false;if(!i&&e&&e.nodeName.IEquals("LI")&&e.parentNode.parentNode.nodeName.IEquals("LI")){this._OutdentWithSelection(e,h);return true;}if(i&&i.nodeName.IEquals("LI")){var c=FCKDomTools.GetLastChild(i,["UL","OL"]);while(c){i=FCKDomTools.GetLastChild(c,"LI");c=FCKDomTools.GetLastChild(i,["UL","OL"]);}}if(i&&e){if(e.nodeName.IEquals("LI")&&!i.nodeName.IEquals("LI")){this._OutdentWithSelection(e,h);return true;}var d=e.parentNode;var a=i.nodeName.toLowerCase();if(FCKListsLib.EmptyElements[a]!=null||a=="table"){FCKDomTools.RemoveNode(i);f=true;}else{FCKDomTools.RemoveNode(e);while(d.innerHTML.Trim().length==0){var b=d.parentNode;b.removeChild(d);d=b;}FCKDomTools.LTrimNode(e);FCKDomTools.RTrimNode(i);h.SetStart(i,2,true);h.Collapse(true);var g=h.CreateBookmark(true);if(!e.tagName.IEquals(["TABLE"])){FCKDomTools.MoveChildren(e,i);}h.SelectBookmark(g);f=true;}}return f;};FCKEnterKey.prototype.DoDelete=function(){FCKUndo.SaveUndoStep();var e=false;var f=new FCKDomRange(this.Window);f.MoveToSelection();if(FCKBrowserInfo.IsIE&&this._CheckIsAllContentsIncluded(f,this.Window.document.body)){this._FixIESelectAllBug(f);return true;}if(f.CheckIsCollapsed()&&f.CheckEndOfBlock(FCKBrowserInfo.IsGeckoLike)){var d=f.StartBlock;var a=FCKTools.GetElementAscensor(d,"td");var c=FCKDomTools.GetNextSourceElement(d,true,[f.StartBlockLimit.nodeName],["UL","OL","TR"],true);if(a){var b=FCKTools.GetElementAscensor(c,"td");if(b!=a){return true;}}e=this._ExecuteBackspace(f,d,c);}f.Release();return e;};FCKEnterKey.prototype.DoTab=function(){var c=new FCKDomRange(this.Window);c.MoveToSelection();var b=c._Range.startContainer;while(b){if(b.nodeType==1){var a=b.tagName.toLowerCase();if(a=="tr"||a=="td"||a=="th"||a=="tbody"||a=="table"){return false;}else{break;}}b=b.parentNode;}if(this.TabText){c.DeleteContents();c.InsertNode(this.Window.document.createTextNode(this.TabText));c.Collapse(false);c.Select();}return true;};FCKEnterKey.prototype._ExecuteEnterBlock=function(k,j){var e=j||new FCKDomRange(this.Window);var m=e.SplitBlock(k);if(m){var n=m.PreviousBlock;var p=m.NextBlock;var f=m.WasStartOfBlock;var d=m.WasEndOfBlock;if(p){if(p.parentNode.nodeName.IEquals("li")){FCKDomTools.BreakParent(p,p.parentNode);FCKDomTools.MoveNode(p,p.nextSibling,true);}}else{if(n&&n.parentNode.nodeName.IEquals("li")){FCKDomTools.BreakParent(n,n.parentNode);e.MoveToElementEditStart(n.nextSibling);FCKDomTools.MoveNode(n,n.previousSibling);}}if(!f&&!d){if(p.nodeName.IEquals("li")&&p.firstChild&&p.firstChild.nodeName.IEquals(["ul","ol"])){p.insertBefore(FCKTools.GetElementDocument(p).createTextNode("\xa0"),p.firstChild);}if(p){e.MoveToElementEditStart(p);}}else{if(f&&d&&n.tagName.toUpperCase()=="LI"){e.MoveToElementStart(n);this._OutdentWithSelection(n,e);e.Release();return true;}var a;if(n){var c=n.tagName.toUpperCase();if(!this._HasShift&&!(/^H[1-6]$/).test(c)){a=FCKDomTools.CloneElement(n);}}else{if(p){a=FCKDomTools.CloneElement(p);}}if(!a){a=this.Window.document.createElement(k);}var o=m.ElementPath;if(o){for(var h=0,l=o.Elements.length;h<l;h++){var g=o.Elements[h];if(g==o.Block||g==o.BlockLimit){break;}if(FCKListsLib.InlineChildReqElements[g.nodeName.toLowerCase()]){g=FCKDomTools.CloneElement(g);FCKDomTools.MoveChildren(a,g);a.appendChild(g);}}}if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(a);}e.InsertNode(a);if(FCKBrowserInfo.IsIE){e.MoveToElementEditStart(a);e.Select();}e.MoveToElementEditStart(f&&!d?p:a);}if(FCKBrowserInfo.IsGeckoLike){if(p){var b=this.Window.document.createElement("span");b.innerHTML="&nbsp;";e.InsertNode(b);FCKDomTools.ScrollIntoView(b,false);e.DeleteContents();}else{FCKDomTools.ScrollIntoView(p||a,false);}}e.Select();}e.Release();return true;};FCKEnterKey.prototype._ExecuteEnterBr=function(i){var e=new FCKDomRange(this.Window);e.MoveToSelection();if(e.StartBlockLimit==e.EndBlockLimit){e.DeleteContents();e.MoveToSelection();var g=e.CheckStartOfBlock();var c=e.CheckEndOfBlock();var h=e.StartBlock?e.StartBlock.tagName.toUpperCase():"";var f=this._HasShift;var a=false;if(!f&&h=="LI"){return this._ExecuteEnterBlock(null,e);}if(!f&&c&&(/^H[1-6]$/).test(h)){FCKDomTools.InsertAfterNode(e.StartBlock,this.Window.document.createElement("br"));if(FCKBrowserInfo.IsGecko){FCKDomTools.InsertAfterNode(e.StartBlock,this.Window.document.createTextNode(""));}e.SetStart(e.StartBlock.nextSibling,FCKBrowserInfo.IsIE?3:1);}else{var b;a=h.IEquals("pre");if(a){b=this.Window.document.createTextNode(FCKBrowserInfo.IsIE?"\r":"\n");}else{b=this.Window.document.createElement("br");}e.InsertNode(b);if(FCKBrowserInfo.IsGecko){FCKDomTools.InsertAfterNode(b,this.Window.document.createTextNode(""));}if(c&&FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(b.parentNode);}if(FCKBrowserInfo.IsIE){e.SetStart(b,4);}else{e.SetStart(b.nextSibling,1);}if(!FCKBrowserInfo.IsIE){var d=null;if(FCKBrowserInfo.IsOpera){d=this.Window.document.createElement("span");}else{d=this.Window.document.createElement("br");}b.parentNode.insertBefore(d,b.nextSibling);FCKDomTools.ScrollIntoView(d,false);d.parentNode.removeChild(d);}}e.Collapse(true);e.Select(a);}e.Release();return true;};FCKEnterKey.prototype._OutdentWithSelection=function(a,b){var c=b.CreateBookmark();FCKListHandler.OutdentListItem(a);b.MoveToBookmark(c);b.Select();};FCKEnterKey.prototype._CheckIsAllContentsIncluded=function(b,e){var d=false;var c=false;if(b.StartContainer==e||b.StartContainer==e.firstChild){d=(b._Range.startOffset==0);}if(b.EndContainer==e||b.EndContainer==e.lastChild){var a=b.EndContainer.nodeType==3?b.EndContainer.length:b.EndContainer.childNodes.length;c=(b._Range.endOffset==a);}return d&&c;};FCKEnterKey.prototype._FixIESelectAllBug=function(a){var c=this.Window.document;c.body.innerHTML="";var b;if(FCKConfig.EnterMode.IEquals(["div","p"])){b=c.createElement(FCKConfig.EnterMode);c.body.appendChild(b);}else{b=c.body;}a.MoveToNodeContents(b);a.Collapse(true);a.Select();a.Release();};