var FCKListCommand=function(a,b){this.Name=a;this.TagName=b;};FCKListCommand.prototype={GetState:function(){if(FCK.EditMode!=FCK_EDITMODE_WYSIWYG||!FCK.EditorWindow){return FCK_TRISTATE_DISABLED;}var b=FCKSelection.GetBoundaryParentElement(true);var a=b;while(a){if(a.nodeName.IEquals(["ul","ol"])){break;}a=a.parentNode;}if(a&&a.nodeName.IEquals(this.TagName)){return FCK_TRISTATE_ON;}else{return FCK_TRISTATE_OFF;}},Execute:function(){FCKUndo.SaveUndoStep();var y=FCK.EditorDocument;var m=new FCKDomRange(FCK.EditorWindow);m.MoveToSelection();var c=this.GetState();if(c==FCK_TRISTATE_OFF){FCKDomTools.TrimNode(y.body);if(!y.body.firstChild){var x=y.createElement("p");y.body.appendChild(x);m.MoveToNodeContents(x);}}var j=m.CreateBookmark();var w=[];var t={};var p=new FCKDomRangeIterator(m);var l;p.ForceBrBreak=(c==FCK_TRISTATE_OFF);var v=true;var k=null;while(v){while((l=p.GetNextParagraph())){var o=new FCKElementPath(l);var d=null;var h=false;var e=o.BlockLimit;for(var u=o.Elements.length-1;u>=0;u--){var a=o.Elements[u];if(a.nodeName.IEquals(["ol","ul"])){if(e._FCK_ListGroupObject){e._FCK_ListGroupObject=null;}var g=a._FCK_ListGroupObject;if(g){g.contents.push(l);}else{g={"root":a,"contents":[l]};w.push(g);FCKDomTools.SetElementMarker(t,a,"_FCK_ListGroupObject",g);}h=true;break;}}if(h){continue;}var r=e;if(r._FCK_ListGroupObject){r._FCK_ListGroupObject.contents.push(l);}else{var g={"root":r,"contents":[l]};FCKDomTools.SetElementMarker(t,r,"_FCK_ListGroupObject",g);w.push(g);}}if(FCKBrowserInfo.IsIE){v=false;}else{if(k==null){k=[];var s=FCKSelection.GetSelection();if(s&&w.length==0){k.push(s.getRangeAt(0));}for(var u=1;s&&u<s.rangeCount;u++){k.push(s.getRangeAt(u));}}if(k.length<1){v=false;}else{var n=FCKW3CRange.CreateFromRange(y,k.shift());m._Range=n;m._UpdateElementInfo();if(m.StartNode.nodeName.IEquals("td")){m.SetStart(m.StartNode,1);}if(m.EndNode.nodeName.IEquals("td")){m.SetEnd(m.EndNode,2);}p=new FCKDomRangeIterator(m);p.ForceBrBreak=(c==FCK_TRISTATE_OFF);}}}var f=[];while(w.length>0){var g=w.shift();if(c==FCK_TRISTATE_OFF){if(g.root.nodeName.IEquals(["ul","ol"])){this._ChangeListType(g,t,f);}else{this._CreateList(g,f);}}else{if(c==FCK_TRISTATE_ON&&g.root.nodeName.IEquals(["ul","ol"])){this._RemoveList(g,t);}}}for(var u=0;u<f.length;u++){var d=f[u];var q=false;var b=d;while(!q){b=b.nextSibling;if(b&&b.nodeType==3&&b.nodeValue.search(/^[\n\r\t ]*$/)==0){continue;}q=true;}if(b&&b.nodeName.IEquals(this.TagName)){b.parentNode.removeChild(b);while(b.firstChild){d.appendChild(b.removeChild(b.firstChild));}}q=false;b=d;while(!q){b=b.previousSibling;if(b&&b.nodeType==3&&b.nodeValue.search(/^[\n\r\t ]*$/)==0){continue;}q=true;}if(b&&b.nodeName.IEquals(this.TagName)){b.parentNode.removeChild(b);while(b.lastChild){d.insertBefore(b.removeChild(b.lastChild),d.firstChild);}}}FCKDomTools.ClearAllMarkers(t);m.MoveToBookmark(j);m.Select();FCK.Focus();FCK.Events.FireEvent("OnSelectionChange");},_ChangeListType:function(h,e,k){var d=FCKDomTools.ListToArray(h.root,e);var j=[];for(var g=0;g<h.contents.length;g++){var b=h.contents[g];b=FCKTools.GetElementAscensor(b,"li");if(!b||b._FCK_ListItem_Processed){continue;}j.push(b);FCKDomTools.SetElementMarker(e,b,"_FCK_ListItem_Processed",true);}var f=FCKTools.GetElementDocument(h.root).createElement(this.TagName);for(var g=0;g<j.length;g++){var c=j[g]._FCK_ListArray_Index;d[c].parent=f;}var a=FCKDomTools.ArrayToList(d,e);for(var g=0;g<a.listNode.childNodes.length;g++){if(a.listNode.childNodes[g].nodeName.IEquals(this.TagName)){k.push(a.listNode.childNodes[g]);}}h.root.parentNode.replaceChild(a.listNode,h.root);},_CreateList:function(k,o){var d=k.contents;var m=FCKTools.GetElementDocument(k.root);var l=[];if(d.length==1&&d[0]==k.root){var h=m.createElement("div");while(d[0].firstChild){h.appendChild(d[0].removeChild(d[0].firstChild));}d[0].appendChild(h);d[0]=h;}var f=k.contents[0].parentNode;for(var j=0;j<d.length;j++){f=FCKDomTools.GetCommonParents(f,d[j].parentNode).pop();}for(var j=0;j<d.length;j++){var g=d[j];while(g.parentNode){if(g.parentNode==f){l.push(g);break;}g=g.parentNode;}}if(l.length<1){return;}var b=l[l.length-1].nextSibling;var e=m.createElement(this.TagName);o.push(e);while(l.length){var c=l.shift();var n=m.createDocumentFragment();while(c.firstChild){n.appendChild(c.removeChild(c.firstChild));}c.parentNode.removeChild(c);var a=m.createElement("li");a.appendChild(n);e.appendChild(a);}f.insertBefore(e,b);},_RemoveList:function(h,f){var e=FCKDomTools.ListToArray(h.root,f);var l=[];for(var g=0;g<h.contents.length;g++){var b=h.contents[g];b=FCKTools.GetElementAscensor(b,"li");if(!b||b._FCK_ListItem_Processed){continue;}l.push(b);FCKDomTools.SetElementMarker(f,b,"_FCK_ListItem_Processed",true);}var j=null;for(var g=0;g<l.length;g++){var d=l[g]._FCK_ListArray_Index;e[d].indent=-1;j=d;}for(var g=j+1;g<e.length;g++){if(e[g].indent>e[g-1].indent+1){var k=e[g-1].indent+1-e[g].indent;var c=e[g].indent;while(e[g]&&e[g].indent>=c){e[g].indent+=k;g++;}g--;}}var a=FCKDomTools.ArrayToList(e,f);if(h.root.nextSibling==null||h.root.nextSibling.nodeName.IEquals("br")){if(a.listNode.lastChild.nodeName.IEquals("br")){a.listNode.removeChild(a.listNode.lastChild);}}h.root.parentNode.replaceChild(a.listNode,h.root);}};