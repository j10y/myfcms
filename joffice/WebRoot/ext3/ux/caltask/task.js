Ext.ECalendar.daytask=function(a){Ext.apply(this,a);Ext.ECalendar.daytask.superclass.constructor.call(this);};Ext.extend(Ext.ECalendar.daytask,Ext.util.Observable,{previndex:0,createdelementno:0,editable:true,parentview:null,baseBody:null,datehandle:new Date(),showQtip:true,tasksOffset:5,task_id:0,task_index:0,task_subject:"",task_starts:"",task_ends:"",task_description:"",task_location:"",task_isholiday:0,task_isallday:0,task_clsOver:"",task_increment:5,task_width:100,forceTaskFit:false,totalTasksonView:0,customHtml:"",customHTMLinpos:"before",bgcolor:"#E0FFA2",task_format:"d-m-Y H:i:s a",moreMenuItems:[],contextMenuLabels:e2cs.cal_locale.contextMenuLabelsDay,task_useBxStyle:false,task_useBxcolor:"#225588",tplqTip:new Ext.XTemplate('<tpl for=".">{starxl}{startval}<br>{endxl}{endval}<hr color="#003366" noshade>{details}</tpl>'),ShowMenuItems:[1,1,1,1,1],evenLaunch:"dblclick",init:function(b,a){this.calx=b;this.vday=a;},render:function(){var t=this.calx.currentdate.format("m/d/Y ")+this.vday.startTime;var h=this.calx.currentdate.format("m/d/Y ")+this.vday.endTime;this.totalhours=this.calx.dateDiff(new Date(t),new Date(h),e2cs.dateParts.HOUR);var o=this.checkTasktime(this.task_starts);var e=this.checkTasktime(this.task_ends);var i=this.calx.currentdate.between(new Date(t),new Date(h));var A=this.calx.dateDiff(new Date(t),new Date(o),e2cs.dateParts.MINUTE);if(A<0){initpos=0;flagstarttasttext=e2cs.cal_locale.task_LessDaysFromTask;}else{initpos=A;flagstarttasttext="";}var d=this.calx.dateDiff(new Date(h),new Date(e),e2cs.dateParts.MINUTE);var s=new Date(e).add(Date.SECOND,-1);var n=this.calx.dateDiff(s,new Date(h),e2cs.dateParts.SECOND);if(d>0&&n!=0){endpos=(this.totalhours)*60;endpos=Math.abs(initpos-endpos);flagendtasttext=e2cs.cal_locale.task_MoreDaysFromTask;}else{var z=new Date(o);var j=new Date(this.calx.currentdate.format("m/d/Y")+" "+this.vday.startTime);if(z<j){endpos=this.calx.dateDiff(new Date(t),new Date(e),e2cs.dateParts.MINUTE);}else{endpos=this.calx.dateDiff(new Date(o),new Date(e),e2cs.dateParts.MINUTE);}flagendtasttext="";}if(this.customHtml==null||this.customHtml==undefined){var u="";var c="";}else{if(this.customHTMLinpos=="before"){var u=this.customHtml;var c="";}else{if(this.customHTMLinpos=="after"){var u="";var c=this.customHtml;}else{var u="";var c="";}}}this.task_index=(this.vday.tasks.length);if(this.forceTaskFit){this.taskobject=this.baseBody.createChild({tag:"div",cls:"task",html:u+flagstarttasttext+this.task_subject+flagendtasttext+c});}else{this.taskobject=this.baseBody.createChild({tag:"div",cls:"task",html:u+flagstarttasttext+this.task_subject+flagendtasttext+c});}this.taskobject.dom.setAttribute("id",this.calx.id+"-ecaltask-"+this.task_index+"");this.taskobject.dom.setAttribute("ec_id",""+this.task_id+"");this.taskobject.dom.setAttribute("ec_starts",""+o+"");this.taskobject.dom.setAttribute("ec_ends",""+e+"");this.taskobject.dom.setAttribute("ec_subject",""+this.task_subject+"");this.taskobject.dom.setAttribute("ec_cnt",""+this.task_description+"");this.taskobject.dom.setAttribute("ec_storeindex",""+this.task_index+"");this.taskobject.dom.setAttribute("ec_location",""+this.task_location+"");this.taskobject.dom.setAttribute("ec_allday",""+this.task_isholiday+"");this.taskobject.dom.setAttribute("ec_isholiday",""+this.task_isallday+"");if(this.forceTaskFit){var b=98/this.totalTasksonView;if(this.task_useBxStyle){this.taskobject.setStyle({border:"1px solid "+this.task_useBxcolor+""});if(Ext.isIE){this.taskobject.setStyle({height:""+(endpos)+"px"});}else{this.taskobject.setStyle({height:""+(endpos-2)+"px"});}this.taskobject.setStyle({width:""+(b)+"%"});}else{this.taskobject.setStyle({height:""+(endpos)+"px"});this.taskobject.setStyle({width:""+(b)+"%"});}}else{this.taskobject.setStyle({top:""+initpos+"px"});if(this.task_useBxStyle){this.taskobject.setStyle({border:"1px solid "+this.task_useBxcolor+""});if(Ext.isIE){this.taskobject.setStyle({height:""+(endpos)+"px"});this.taskobject.setStyle({width:""+(this.task_width)+"px"});}else{this.taskobject.setStyle({height:""+(endpos-2)+"px"});this.taskobject.setStyle({width:""+(this.task_width-2)+"px"});}}else{this.taskobject.setStyle({height:""+(endpos)+"px"});this.taskobject.setStyle({width:""+(this.task_width)+"px"});}if(this.tasksOffset=="auto"){if(this.task_index<=1){var r=0;}else{f=this.task_width;r=0;for(var m=0;m<=(this.vday.tasks.length-1);m++){if(m!=0){r+=Ext.get(this.calx.id+"-ecaltask-"+(m)).getWidth(false);}}}}else{var r=0;if(this.task_index<=1){var f=0;}else{f=this.tasksOffset;this.taskobject.setStyle("margin-left",(f)+"px");}}newancho=0;for(var m=0;m<=(this.vday.tasks.length);m++){if(m!=0){newancho+=Ext.get(this.calx.id+"-ecaltask-"+(m)).getWidth(false);}}if(newancho>this.baseBody.getWidth(false)){Ext.get(this.calx.id+"-daybody").setWidth(newancho);Ext.get("tdbaseday").setWidth(newancho);}if(Ext.isOpera){}else{}}this.taskobject.setY(this.baseBody.getY()+initpos);if(this.bgcolor){this.taskobject.setStyle("background-color",""+this.bgcolor+"");}else{this.taskobject.setStyle("background-color","#99CC99");}if(Ext.isIE){this.taskobject.setStyle("z-index","2000");}else{this.taskobject.setStyle("z-index","auto");}if(this.showQtip){var z=new Date(o);var a=z.format(this.task_format);z=new Date(e);var B=z.format(this.task_format);this.taskobject.dom.qtitle=this.task_subject;if(this.task_description==""){var C="&nbsp;<br/>&nbsp;";}else{var C=this.task_description;}var l={starxl:e2cs.cal_locale.task_qtip_starts,startval:a,endxl:e2cs.cal_locale.task_qtip_ends,endval:B,details:C,location:this.task_location};this.taskobject.dom.qtip=this.tplqTip.apply(l);}if(this.task_clsOver!=""){this.taskobject.addClassOnOver(this.task_clsOver);}this.taskobject.addListener(this.evenLaunch,this.onDblclick,this);if(Ext.isOpera){this.taskobject.addListener("mousedown",this.operabuttons,this);}else{this.taskobject.addListener("contextmenu",this.oncontextmenu,this,{stopPropagation:true,normalized:true,preventDefault:true});}if(initpos==0&&endpos>(this.totalhours*60)){}else{if(this.editable){if(flagendtasttext==""){if(Ext.isIE){var w=true;}else{var w=false;}var q=new Ext.Resizable(this.calx.id+"-ecaltask-"+this.task_index+"",{pinned:w,width:this.task_width,handles:"s",heightIncrement:this.task_increment,minHeight:15,maxHeight:((this.totalhours*60)-initpos),dynamic:true,draggable:false});var k=this.baseBody;var g=this.vday;var y=this;var v=this.calx;q.on({"resize":{fn:function(I,G,x,E){var F=y.getTaskarray(I.el);var D=v.fireEvent("beforeTaskMove",F,y,g,v);if(D){y.applyChange(I.el);var H=y.getTaskarray(I.el);v.fireEvent("TaskMoved",H,y,g,null);}},scope:this}});if(flagstarttasttext==""&&flagendtasttext==""){var p=new Ext.dd.DDProxy(this.calx.id+"-ecaltask-"+this.task_index+"","task-group",{xTicks:0,yTicks:5});var k=this.baseBody;var g=this.vday;var y=this;var v=this.calx;p.startDrag=function(){this.constrainTo(k.id);this.setXConstraint(0,0,0);var x=Ext.get(this.getDragEl());var D=Ext.get(this.getEl());x.applyStyles({border:"","z-index":2000});x.update(D.dom.innerHTML);x.addClass("task-drag"+" dd-proxy");};p.endDrag=function(){var x=Ext.get(this.getDragEl());var F=Ext.get(this.getEl());var E=y.getTaskarray(this.id);var D=v.fireEvent("beforeTaskMove",E,y,g,v);if(D){F.setY(x.getY());y.applyChange(this);var G=y.getTaskarray(this.id);v.fireEvent("TaskMoved",G,y,g,this);}else{}};}}}}},operabuttons:function(b,c,a){if(Ext.isOpera){if(b.button==2){this.oncontextmenu(b,c,a);}}},oncontextmenu:function(j,d,k){if(Ext.isOpera){if(j.button!=2){return false;}}if(this.ShowMenuItems[0]!=true&&this.ShowMenuItems[1]!=true&&this.ShowMenuItems[2]!=true&&this.ShowMenuItems[3]!=true&&this.ShowMenuItems[4]!=true&&this.moreMenuItems.length<=0){return false;}j.stopEvent();if(d.id.indexOf(this.calx.id+"-ecaltask-")<0){var a=Ext.get(d.parentNode.id);}else{var a=Ext.get(d.id);}var h=this.getTaskarray(a);var b=this.vday.moreMenuItems;var l=this.ShowMenuItems;var f=[];var c=this.calx.fireEvent("beforeContextMenuTask","dayview-task",h,l,f);if(c==false){if(f[0]==false){if(f[1]==true){if(f[2]==true){var b=f[3];}var l=f[4];}else{var b=this.vday.moreMenuItems;var l=this.ShowMenuItems;}}else{return false;}}else{var b=this.vday.moreMenuItems;}if(this.menu){this.menu.removeAll();}this.menu=new Ext.menu.Menu({allowOtherMenus:true,shadow:false,items:[{id:"day_ctxbtn_task-add",iconCls:"x-calendar-day-btnmv_add",text:this.contextMenuLabels.taskAdd,scope:this},{id:"month_ctxbtn_task-delete",iconCls:"x-calendar-day-btnmv_delete",text:this.contextMenuLabels.taskDelete,scope:this},"-",{id:"month_ctxbtn_task-edit",iconCls:"x-calendar-day-btnmv_task",text:this.contextMenuLabels.taskEdit+a.getAttributeNS("tag","ec_subject"),scope:this},"-",{id:"month_ctxbtn_task-go-nd",iconCls:"x-calendar-day-btnmv_nextday",text:this.contextMenuLabels.NextDay,scope:this},{id:"month_ctxbtn_task-go-pd",iconCls:"x-calendar-day-btnmv_prevday",text:this.contextMenuLabels.PreviousDay,scope:this}]});if(b.length>0){this.menu.add("-");for(var e=0;e<b.length;e++){b[e].rendered=false;if(b[e].menu==undefined){b[e].rendered=false;if(b[e].ctype=="Ext.menu.Item"){b[e].addListener("click",function(m,i){this.onCustomMenuAction(m.id,Ext.get(d),this);},this);}else{}this.menu.add(b[e]);}else{b[e].menu.rendered=false;for(var g=0;g<b[e].menu.items.length;g++){b[e].menu.items.items[g].rendered=false;if(b[e].menu.items.items[g].ctype=="Ext.menu.Item"){b[e].menu.items.items[g].addListener("click",function(m,i){this.onCustomMenuAction(m.id,Ext.get(d),this);},this);}else{}}this.menu.add(b[e]);}}}this.menu.items.items[0].addListener("click",function(){this.onActionTask(1,Ext.get(d),this);},this);this.menu.items.items[1].addListener("click",function(){this.onActionTask(2,Ext.get(d),this);},this);this.menu.items.items[3].addListener("click",function(){this.onActionTask(3,Ext.get(d),this);},this);this.menu.items.items[5].addListener("click",function(){this.vday.onclicknext_day();},this);this.menu.items.items[6].addListener("click",function(){this.vday.onclickprev_day();},this);if(l[0]!=true){this.menu.items.items[0].hidden=true;}if(l[1]!=true){this.menu.items.items[1].hidden=true;}if(l[0]!=true&&l[1]!=true){this.menu.items.items[2].hidden=true;}if(l[2]!=true&&l[3]!=true&l[4]!=true&b.length<=0){this.menu.items.items[2].hidden=true;}if(l[2]!=true){this.menu.items.items[3].hidden=true;this.menu.items.items[4].hidden=true;}if(l[3]!=true&&l[4]!=true&b.length<=0){this.menu.items.items[4].hidden=true;}if(l[3]!=true){this.menu.items.items[5].hidden=true;}if(l[4]!=true){this.menu.items.items[6].hidden=true;}if(b.length>0){if(l[3]!=true&&l[4]!=true){this.menu.items.items[7].hidden=true;}}this.menu.on("hide",this.onContextTaskMenuHide,this);this.menu.showAt(j.xy);},onCustomMenuAction:function(b,d,c){var a=this.getTaskarray(d);this.calx.fireEvent("customMenuAction",b,"day",a,d,this.vday);this.menu.hide();},applyChange:function(i){var e=this.calx.currentdate.format("m/d/Y ")+this.vday.startTime;var c=this.calx.currentdate.format("m/d/Y ")+this.vday.endTime;var a=Ext.get(i.id);var f=Math.abs(a.getTop()-Ext.get(this.baseBody).getY());var b=a.getHeight();var h=new Date(e).add(Date.MINUTE,f);var j=h.add(Date.MINUTE,b);a.dom.setAttribute("ec_starts",""+h.format("m/d/Y H:i:s a")+"");a.dom.setAttribute("ec_ends",""+j.format("m/d/Y H:i:s a")+"");if(this.showQtip){var d=h.format(this.task_format);var g=j.format(this.task_format);a.dom.qtip=e2cs.cal_locale.task_qtip_starts+d+"<br>"+e2cs.cal_locale.task_qtip_ends+g+"<br>"+this.task_description;}},onActionTask:function(c,e,d){var b=this.getTaskarray(e);switch(c){case 1:this.calx.fireEvent("taskAdd",this.calx.currentdate);break;case 2:var a=this.calx.fireEvent("beforeTaskDelete",b,this.vday);if(a){if(this.calx.fireEvent("onTaskDelete",b)==true){this.calx.fireEvent("afterTaskDelete",b,true);}else{this.calx.fireEvent("afterTaskDelete",null,false);}}break;case 3:var a=this.calx.fireEvent("beforeTaskEdit",b,this.vday);if(a){if(this.calx.fireEvent("onTaskEdit",b)==true){this.calx.fireEvent("afterTaskEdit",b,true);}else{this.calx.fireEvent("afterTaskEdit",null,false);}}break;default:break;}},onContextTaskMenuHide:function(){},onDblclick:function(c,e,b){if(e.id.indexOf(this.calx.id+"-ecaltask-")<0){var d=Ext.get(e.parentNode.id);}else{var d=Ext.get(e.id);}var a=this.getTaskarray(d);this.calx.fireEvent("taskDblClick",a,this.vday,this.calx,"day");},getTaskarray:function(a){var c=Ext.get(a);var b=[];b[0]=c.getAttributeNS("tag","id");b[1]=c.getAttributeNS("tag","ec_id");b[2]=c.getAttributeNS("tag","ec_subject");b[3]=c.getAttributeNS("tag","ec_starts");b[4]=c.getAttributeNS("tag","ec_ends");b[5]=c.getAttributeNS("tag","ec_cnt");b[6]=c.getAttributeNS("tag","ec_storeindex");b[7]=c.getAttributeNS("tag","ec_location");b[8]=c.getAttributeNS("tag","ec_allday");b[9]=c.getAttributeNS("tag","ec_isholiday");return b;},checkTasktime:function(a){if(a instanceof Date){var b=a.format("m/d/Y G:i");}else{var b=a;}var c=b.indexOf(":",0);if(c<=0){taskvaluefix=b+" "+this.vday.startTime;}else{taskvaluefix=b;}return taskvaluefix;}});