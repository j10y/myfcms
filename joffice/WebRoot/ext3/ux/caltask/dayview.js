Ext.ECalendar.dayview=function(a){Ext.apply(this,a);this.addEvents("beforeDayChange","afterDayChange");Ext.ECalendar.dayview.superclass.constructor.call(this);};Ext.extend(Ext.ECalendar.dayview,Ext.util.Observable,{referid:"dayview",header:true,headerFormat:"星期l - d - F  - Y",headerButtons:true,moreMenuItems:[],hourFormat:"G:i",startTime:"7:00:00 am",endTime:"10:00:00 pm",scrolltoHour:false,task_useBorderStyle:false,task_useBordercolor:"#225588",taskBaseColor:"#ffffff",useMultiColorTasks:false,multiColorTasks:[],task_increment:5,task_width:50,tasksOffset:0,task_clsOver:"",task_showqtip:true,task_format:"Y-m-d H:i:s",taskAdd_dblclick:true,taskAdd_timer_dblclick:true,task_DDeditable:true,task_eventLaunch:"click",ShowMenuItems:[1,1,1,1,1,1],task_ShowMenuItems:[1,1,1,1,1],customHTMLinpos:"before",forceTaskFit:false,headerUseTpl:false,headerTpl:new Ext.XTemplate('<tpl for=".">{title}-{datetouse:this.formatx}</tpl>',{formatx:function(a){return a.format("l - d - F  - Y");}}),headerData:{title:"Custom header for Day",datetouse:new Date()},tasks:[],init:function(b,a){this.calx=b;this.datetohandle=a;},refreshView:function(){this.render();},render:function(){var r=Ext.get(this.calx.body);var c=r.dom.childNodes.length;if(c){for(var H=c;H<c;H++){r.dom.removeChild(r.dom.childNodes[0]);}}r.update("");var r=Ext.get(this.calx.body);var h='<div id="'+this.calx.id+'-main-calendar-header"></div>';h+='<div id="'+this.calx.id+'-main-calendar-day-body"></div>';r.update(h);this.datetohandle=this.calx.currentdate;if(this.header){var f=this.datetohandle;var p=this.genHeader(this.datetohandle);var p=Ext.get(this.calx.id+"-main-calendar-header");var b=p;var D=b.wrap({tag:"div",cls:"x-calendar-dayv-header",html:""});if(this.headerButtons){var k=D.createChild({id:this.calx.id+"-btn-pd",tag:"div",cls:"x-calendar-day-previous",html:""});var E=D.createChild({id:this.calx.id+"-btn-nd",tag:"div",cls:"x-calendar-day-next",html:""});k.dom["qtip"]=e2cs.cal_locale.headerTooltipsDay.prev;k.addListener("click",this.onclickprev_day,this);k.addClassOnOver("x-calendar-day-previous-over");E.dom["qtip"]=e2cs.cal_locale.headerTooltipsDay.next;E.addListener("click",this.onclicknext_day,this);E.addClassOnOver("x-calendar-day-next-over");}if(this.headerUseTpl){var J=this.headerTpl.apply(this.headerData);var u=D.createChild({tag:"div",id:"header",html:""+J+""});}else{var u=D.createChild({tag:"div",id:"header",html:""+f.format(this.headerFormat)+""});}}Ext.get(this.calx.id+"-main-calendar-header").setStyle("z-index","99999");var e=this.genBody(this.datetohandle);var a=Ext.get(this.calx.id+"-main-calendar-day-body");var A=a.wrap({tag:"div",cls:"x-calendar-dayv-day",html:""});if(Ext.isIE){A.setStyle({position:"relative"});}if(this.calx.ownerCt!=undefined){if(this.calx.ownerCt.ctype&&this.calx.ownerCt.ctype=="Ext.Component"){this.calx.height=this.calx.ownerCt.getInnerHeight();}}if(!this.calx.height||this.calx.height=="undefined"){if(this.calx.getEl().dom.offsetParent!=null){var m=this.calx.getEl().dom.offsetParent.clientHeight;}else{var m=0;}}else{var m=this.calx.height;}if(m==0){m=300;}if(this.header){m+=-24;}if(this.calx.showCal_tbar){m+=-26;}if(this.calx.header){m+=-26;}var y=0;A.setStyle({height:""+m-y+"px"});A.setStyle({overflow:"auto"});tmpid=this.calx.id;A.addListener("scroll",function(){if(Ext.get(tmpid+"-daybody")){Ext.get(tmpid+"-daybody").setStyle("filter","alpha(opacity=100)");Ext.get(tmpid+"-daybody").setStyle("filter","");}});var j=A.createChild({tag:"div",id:this.calx.id+"-calendar-view-day",html:e});if(Ext.isIE){j.setStyle({position:"relative"});}if(Ext.isIE||Ext.isIE6){Ext.get("daylayoutbody").setStyle({position:"relative"});Ext.get("daylayoutbody").setWidth(Ext.get("daylayoutbody").getWidth()-25,false);Ext.get(this.calx.id+"-tableallday").setStyle({position:"relative"});}var w=Ext.get(this.calx.id+"-daybody");var z=this.calx.currentdate;var l=this.calx;var q=this.taskAdd_dblclick;if(q){w.addListener("dblclick",function(O,Q,M){if(Q.id.indexOf("-daybody")<0){return false;}var N=z;var i=Ext.get(l.id+"-calendar-view-day").getY();if(Ext.isIE){var P=Ext.select("td.hour-marker_ie",true);}else{var P=Ext.select("td.hour-marker",true);}P.each(function(V,R,T){if(V.id.indexOf(l.id+"-tdbody-dayv-")+1>=1){var W=Ext.get(V).getY();var S=Ext.get(V).getHeight();var X=O.getPageY();if(X>=W&&X<=(W+S)){if(V.id.indexOf(l.id+"-tdbody-dayv-")<0){var U=Ext.get(V).parent().id.replace(l.id+"-tdbody-dayv-","");}else{var U=V.id.replace(l.id+"-tdbody-dayv-","");}N=new Date(U);return false;}else{return true;}}},this);l.fireEvent("taskAdd",N);});}if(this.taskAdd_timer_dblclick){if(Ext.isIE){var K=Ext.select("td.hour-marker_ie",true);}else{var K=Ext.select("td.hour-marker",true);}K.each(function(N,i,M){if(N.id.indexOf(l.id+"-tdbody-dayv-")+1>=1){N.addListener("dblclick",function(R,S,Q){if(S.id.indexOf(l.id+"-tdbody-dayv-")<0){var O=Ext.get(S).parent().id.replace(l.id+"-tdbody-dayv-","");}else{var O=S.id.replace(l.id+"-tdbody-dayv-","");}var P=new Date(O);l.fireEvent("taskAdd",P);});}},this);}w.setHeight(Ext.get("tdbaseday").getHeight(true));if(Ext.isOpera){w.addListener("mousedown",this.operadaybuttons,this);}else{w.addListener("contextmenu",this.oncontextmenuBody,this,{stopPropagation:false,normalized:true,preventDefault:true});}this.tasks=[];var d=new Date(this.datetohandle.format("m/d/Y")+" "+this.startTime);var G=new Date(this.datetohandle.format("m/d/Y")+" "+this.endTime);var B=this.calx.store.getCount();var t=0;for(var H=0;H<B;H++){var s=this.calx.store.getAt(H).data;testdateinit=this.calx.store.getAt(H).data[this.calx.fieldsRefer.startdate];testdateend=this.calx.store.getAt(H).data[this.calx.fieldsRefer.enddate];checkdates=this.datetohandle.between(new Date(testdateinit),new Date(testdateend));chkformat=this.datetohandle.format("m/d/Y");g=new Date(testdateinit);if(g.format("m/d/Y")==chkformat){checkdates=true;}g=new Date(testdateend);if(g.format("m/d/Y")==chkformat){checkdates=true;}if(checkdates){t+=1;}}var B=t;if(B>0){currentindex=0;created=0;previndex=0;if(this.tasksOffset=="auto"){var o=B*this.task_width;}else{var o=(B*this.task_width)-((B-1)*this.tasksOffset);}if(Ext.get("tdbaseday").getWidth(true)<o){if(!this.calx.width||this.calx.width=="undefined"){}else{Ext.get(this.calx.id+"-daybody").setWidth(o,false);Ext.get("daylayoutbody").setWidth(Ext.get(this.calx.id+"-tableallday").getWidth(true)+1,false);}var g=11;}var B=this.calx.store.getCount();var F=[];for(var L=0;L<B;L++){dateinit=this.calx.store.getAt(L).data[this.calx.fieldsRefer.startdate];dateend=this.calx.store.getAt(L).data[this.calx.fieldsRefer.enddate];checkdates=this.datetohandle.between(new Date(dateinit),new Date(dateend));chkformat=this.datetohandle.format("m/d/Y");g=new Date(dateinit);if(g.format("m/d/Y")==chkformat){checkdates=true;}g=new Date(dateend);if(g.format("m/d/Y")==chkformat){checkdates=true;}if(checkdates){F.push(L);}}for(var H=0;H<F.length;H++){L=F[H];if(this.calx.store.getAt(L).data[this.calx.fieldsRefer.color]){colortask=this.calx.store.getAt(L).data[this.calx.fieldsRefer.color];}else{colortask=this.taskBaseColor;}var x=this.calx.store.getAt(L).data[this.calx.fieldsRefer.description];var n=x;if(x.length>this.calx.tipmaxLength){n=x.substring(0,this.calx.tipmaxLength)+"...";}var I=this.calx.store.getAt(L).data[this.calx.fieldsRefer.isHoliday];if(I==undefined||I==""){I=0;}var v=this.calx.store.getAt(L).data[this.calx.fieldsRefer.task_isallday];if(v==undefined||v==""){v=0;}this.tasks[H]=new Ext.ECalendar.daytask({tasksOffset:this.tasksOffset,evenLaunch:this.task_eventLaunch,editable:this.task_DDeditable,parentview:this,baseBody:w,datehandle:this.datetohandle,showQtip:this.task_showqtip,contextMenuLabels:e2cs.cal_locale.contextMenuLabelsDay,tplqTip:this.calx.tplTaskTip,task_index:L,task_id:this.calx.store.getAt(L).data[this.calx.fieldsRefer.id],task_subject:this.calx.store.getAt(L).data[this.calx.fieldsRefer.subject],task_starts:this.calx.store.getAt(L).data[this.calx.fieldsRefer.startdate],task_ends:this.calx.store.getAt(L).data[this.calx.fieldsRefer.enddate],task_description:n,customHtml:this.calx.store.getAt(L).data[this.calx.fieldsRefer.html],customHTMLinpos:this.customHTMLinpos,task_clsOver:this.task_clsOver,task_increment:this.task_increment,task_width:this.task_width,task_format:this.task_format,bgcolor:colortask,moreMenuItems:this.moreMenuItems,ShowMenuItems:this.task_ShowMenuItems,forceTaskFit:this.forceTaskFit,totalTasksonView:F.length,task_useBxStyle:this.task_useBorderStyle,task_useBxcolor:this.task_useBordercolor,task_location:this.calx.store.getAt(L).data[this.calx.fieldsRefer.location],task_isholiday:I,task_isallday:v});this.tasks[H].init(this.calx,this);this.tasks[H].render();}if(Ext.get("daylayoutbody").getWidth(true)<Ext.get(this.calx.id+"-tableallday").getWidth(true)){Ext.get("daylayoutbody").setWidth(Ext.get(this.calx.id+"-tableallday").getWidth(true)+1,false);}if(this.tasks.length<=0){w.update("&nbsp;");}}else{w.update("&nbsp;");}A.dom.scrollTop=0;if(this.scrolltoHour){var C=0;if(Ext.isIE){var K=Ext.select("td.hour-marker_ie",true);}else{var K=Ext.select("td.hour-marker",true);}K.each(function(O,M,N){if(O.id.indexOf(l.id+"-tdbody-dayv-")+1>=1){var i=this.datetohandle.format("G:i");if(O.id.indexOf(i)+1>=1){C=Ext.get(O).getY();return false;}}},this);if(C>0){C=C-A.getY();A.dom.scrollTop=C;}}},operadaybuttons:function(b,c,a){if(Ext.isOpera){if(b.button==2){this.oncontextmenuBody(b,c,a);}}else{return false;}},oncontextmenuBody:function(b,d,a){if(Ext.isOpera){if(b.button!=2){return false;}}if(this.ShowMenuItems[0]!=true&&this.ShowMenuItems[1]!=true&&this.ShowMenuItems[2]!=true&&this.ShowMenuItems[3]!=true&&this.ShowMenuItems[4]!=true&&this.ShowMenuItems[5]!=true){return false;}b.stopEvent();if(d.id.indexOf(this.calx.id+"-daybody")<0){return false;}var c=Ext.get(d.id);if(this.menu){this.menu.removeAll();}this.menu=new Ext.menu.Menu({id:this.calx.id+"-contextmenu-day",shadow:true,items:[{id:this.calx.id+"-day_ctxbtn_task-add",iconCls:"x-calendar-day-btnmv_add",text:e2cs.cal_locale.contextMenuLabelsDay.taskAdd,scope:this},"-",{id:this.calx.id+"-day_ctxbtn_task-go-nd",iconCls:"x-calendar-day-btnmv_nextday",text:e2cs.cal_locale.contextMenuLabelsDay.NextDay,scope:this},{id:this.calx.id+"-day_ctxbtn_task-go-pd",iconCls:"x-calendar-day-btnmv_prevday",text:e2cs.cal_locale.contextMenuLabelsDay.PreviousDay,scope:this},"-",{id:this.calx.id+"-day_ctxbtn_viewmonth",iconCls:"x-calendar-month-btnmv_viewmonth",text:e2cs.cal_locale.contextMenuLabelsDay.chgmview,scope:this},{id:this.calx.id+"-day_ctxbtn_viewweek",iconCls:"x-calendar-month-btnmv_viewweek",text:e2cs.cal_locale.contextMenuLabelsDay.chgwview,scope:this},{id:this.calx.id+"-day_ctxbtn_viewsched",iconCls:"x-calendar-month-btnmv_viewsched",text:e2cs.cal_locale.contextMenuLabelsDay.chgsview,scope:this}]});this.menu.items.items[0].addListener("click",function(){var g=this.calx.currentdate;var f=this.calx;var e=Ext.get(this.calx.id+"-calendar-view-day").getY();if(Ext.isIE){var h=Ext.select("td.hour-marker_ie",true);}else{var h=Ext.select("td.hour-marker",true);}h.each(function(m,i,k){if(m.id.indexOf(f.id+"-tdbody-dayv-")+1>=1){var n=Ext.get(m).getY();var j=Ext.get(m).getHeight();var o=b.getPageY();if(o>=n&&o<=(n+j)){if(m.id.indexOf(f.id+"-tdbody-dayv-")<0){var l=Ext.get(m).parent().id.replace(f.id+"-tdbody-dayv-","");}else{var l=m.id.replace(f.id+"-tdbody-dayv-","");}g=new Date(l);return false;}else{return true;}}},this);this.calx.fireEvent("taskAdd",g);},this);this.menu.items.items[2].addListener("click",function(){this.onclicknext_day();},this);this.menu.items.items[3].addListener("click",function(){this.onclickprev_day();},this);this.menu.items.items[5].addListener("click",function(){this.changeCalview(Ext.get(d),this,1);},this);this.menu.items.items[6].addListener("click",function(){this.changeCalview(Ext.get(d),this,2);},this);this.menu.items.items[7].addListener("click",function(){this.changeCalview(Ext.get(d),this,3);},this);if(this.ShowMenuItems[0]!=true){this.menu.items.items[0].hidden=true;this.menu.items.items[1].hidden=true;}if(this.ShowMenuItems[1]!=true&&this.ShowMenuItems[2]!=true&&this.ShowMenuItems[3]!=true&&this.ShowMenuItems[4]!=true&&this.ShowMenuItems[1]!=true){this.menu.items.items[1].hidden=true;}if(this.ShowMenuItems[1]!=true){this.menu.items.items[2].hidden=true;}if(this.ShowMenuItems[2]!=true){this.menu.items.items[3].hidden=true;}if(this.ShowMenuItems[1]!=true&&this.ShowMenuItems[2]!=true){this.menu.items.items[4].hidden=true;}if(this.ShowMenuItems[3]!=true){this.menu.items.items[5].hidden=true;}if(this.ShowMenuItems[4]!=true){this.menu.items.items[6].hidden=true;}if(this.ShowMenuItems[5]!=true){this.menu.items.items[7].hidden=true;}if(!this.calx.mview){this.menu.items.items[5].hidden=true;}if(!this.calx.wview){this.menu.items.items[6].hidden=true;}if(!this.calx.sview){this.menu.items.items[7].hidden=true;}this.menu.showAt([b.getPageX(),b.getPageY()]);},changeCalview:function(c,d,b){if(c.dom.className=="noday"||c.dom.className=="today"||c.dom.className=="monthday"){var a=new Date(c.id);}else{if(c.dom.className=="tasks"){var a=new Date(c.dom.parentNode.firstChild.id);}else{var a=new Date(c.dom.firstChild.id);}}if(b==1){varview="month";}else{if(b==2){varview="week";}else{varview="schedule";}}this.calx.changeView(varview);},onclickprev_day:function(d,e,c){var b=this.datetohandle.add(Date.DAY,-1);var a=this.fireEvent("beforeDayChange",this.datetohandle,b);if(a){this.calx.currentdate=b;this.datetohandle=b;this.render();this.fireEvent("afterDayChange",b);}},onclicknext_day:function(d,e,c){var b=this.datetohandle.add(Date.DAY,1);var a=this.fireEvent("beforeDayChange",this.datetohandle,b);if(a){this.calx.currentdate=b;this.datetohandle=b;this.render();this.fireEvent("afterDayChange",b);}},genHeader:function(c){var b=new Date(c);Date.monthNames=e2cs.cal_locale.monthtitles;Date.dayNames=e2cs.cal_locale.daytitles;var a='<div class="x-calendar-dayv-header" style="width:'+(this.calx.width-10)+'px;">';a+='<div id="header">'+b.format(this.headerFormat)+"</div>";if(this.headerButtons){a+='<div class="x-calendar-day-previous"></div>';a+='<div class="x-calendar-day-next"></div>';}a+="</div>";return a;},genBody:function(k){var a=new Date(k);var e=new Date(a.format("m/d/Y")+" "+this.startTime);var b=new Date(a.format("m/d/Y")+" "+this.endTime);this.diffhrs=this.calx.dateDiff(e,b,e2cs.dateParts.HOUR);var d="";if(Ext.isIE||Ext.isIE6){d="97.8";}else{d="100";}d="100";var c='<div id="daylayoutbody" class="x-calendar-dayv-body">';c+='<table id="'+this.calx.id+'-tableallday" width="'+d+'%" border="0" cellspacing="1" cellpadding="0"><tr><td valign="top" width="50">';c+='<table width="50" border="0" align="center" cellpadding="0" cellspacing="0">';for(var h=0;h<this.diffhrs;h++){tmpdatetohandleontd=a.format("m/d/Y");tmpdatetohandleontd+=" "+e.add(Date.HOUR,(h)).format("G");tmpdatetohandleontd+=":"+e.add(Date.HOUR,(h)).format("i");if(Ext.isIE){var g="hour-marker_ie";var f=' align="center" valign="middle" ';}else{var g="hour-marker";var f="";}c+="<tr><td "+f+' id="'+this.calx.id+"-tdbody-dayv-"+tmpdatetohandleontd+'" class="'+g+'">';c+="<span>"+e.add(Date.HOUR,(h)).format(this.hourFormat)+"</span></td></tr>";}var j="";if(Ext.isIE||Ext.isIE6||Ext.isIE7){j=' style="position:relative;" ';}c+='</table></td><td valign="top" id="tdbaseday"'+j+">";if(Ext.isIE||Ext.isIE6||Ext.isIE7){c+='<div id="'+this.calx.id+'-daybody" class="basegridday_ie6"'+j+">";}else{c+='<div id="'+this.calx.id+'-daybody" class="basegridday">';}c+="&nbsp;";c+="</div>";c+="</td></tr></table>";c+="</div>";return c;}});