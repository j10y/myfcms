var FCKDomRangeIterator=function(a){this.Range=a;this.ForceBrBreak=false;this.EnforceRealBlocks=false;};FCKDomRangeIterator.CreateFromSelection=function(b){var a=new FCKDomRange(b);a.MoveToSelection();return new FCKDomRangeIterator(a);};FCKDomRangeIterator.prototype={GetNextParagraph:function(){var i;var l;var j;var o;var b;var h=this.ForceBrBreak?FCKListsLib.ListBoundaries:FCKListsLib.BlockBoundaries;if(!this._LastNode){var l=this.Range.Clone();l.Expand(this.ForceBrBreak?"list_contents":"block_contents");this._NextNode=l.GetTouchedStartNode();this._LastNode=l.GetTouchedEndNode();l=null;}var e=this._NextNode;var c=this._LastNode;this._NextNode=null;while(e){var g=false;var f=(e.nodeType!=1);var n=false;if(!f){var m=e.nodeName.toLowerCase();if(h[m]&&(!FCKBrowserInfo.IsIE||e.scopeName=="HTML")){if(m=="br"){f=true;}else{if(!l&&e.childNodes.length==0&&m!="hr"){i=e;j=e==c;break;}}if(l){l.SetEnd(e,3,true);if(m!="br"){this._NextNode=FCKDomTools.GetNextSourceNode(e,true,null,c)||e;}}g=true;}else{if(e.firstChild){if(!l){l=new FCKDomRange(this.Range.Window);l.SetStart(e,3,true);}e=e.firstChild;continue;}f=true;}}else{if(e.nodeType==3){if(/^[\r\n\t ]+$/.test(e.nodeValue)){f=false;}}}if(f&&!l){l=new FCKDomRange(this.Range.Window);l.SetStart(e,3,true);}j=((!g||f)&&e==c);if(l&&!g){while(!e.nextSibling&&!j){var k=e.parentNode;if(h[k.nodeName.toLowerCase()]){g=true;j=j||(k==c);break;}e=k;f=true;j=(e==c);n=true;}}if(f){l.SetEnd(e,4,true);}if((g||j)&&l){l._UpdateElementInfo();if(l.StartNode==l.EndNode&&l.StartNode.parentNode==l.StartBlockLimit&&l.StartNode.getAttribute&&l.StartNode.getAttribute("_fck_bookmark")){l=null;}else{break;}}if(j){break;}e=FCKDomTools.GetNextSourceNode(e,n,null,c);}if(!i){if(!l){this._NextNode=null;return null;}i=l.StartBlock;if(!i&&!this.EnforceRealBlocks&&l.StartBlockLimit.nodeName.IEquals("DIV","TH","TD")&&l.CheckStartOfBlock()&&l.CheckEndOfBlock()){i=l.StartBlockLimit;}else{if(!i||(this.EnforceRealBlocks&&i.nodeName.toLowerCase()=="li")){i=this.Range.Window.document.createElement(FCKConfig.EnterMode=="p"?"p":"div");l.ExtractContents().AppendTo(i);FCKDomTools.TrimNode(i);l.InsertNode(i);o=true;b=true;}else{if(i.nodeName.toLowerCase()!="li"){if(!l.CheckStartOfBlock()||!l.CheckEndOfBlock()){i=i.cloneNode(false);l.ExtractContents().AppendTo(i);FCKDomTools.TrimNode(i);var p=l.SplitBlock();o=!p.WasStartOfBlock;b=!p.WasEndOfBlock;l.InsertNode(i);}}else{if(!j){this._NextNode=i==c?null:FCKDomTools.GetNextSourceNode(l.EndNode,true,null,c);return i;}}}}}if(o){var a=i.previousSibling;if(a&&a.nodeType==1){if(a.nodeName.toLowerCase()=="br"){a.parentNode.removeChild(a);}else{if(a.lastChild&&a.lastChild.nodeName.IEquals("br")){a.removeChild(a.lastChild);}}}}if(b){var d=i.lastChild;if(d&&d.nodeType==1&&d.nodeName.toLowerCase()=="br"){i.removeChild(d);}}if(!this._NextNode){this._NextNode=(j||i==c)?null:FCKDomTools.GetNextSourceNode(i,true,null,c);}return i;}};