var FCKStyle=function(a){this.Element=(a.Element||"span").toLowerCase();this._StyleDesc=a;};FCKStyle.prototype={GetType:function(){var b=this.GetType_$;if(b!=undefined){return b;}var a=this.Element;if(a=="#"||FCKListsLib.StyleBlockElements[a]){b=FCK_STYLE_BLOCK;}else{if(FCKListsLib.StyleObjectElements[a]){b=FCK_STYLE_OBJECT;}else{b=FCK_STYLE_INLINE;}}return(this.GetType_$=b);},ApplyToSelection:function(b){var a=new FCKDomRange(b);a.MoveToSelection();this.ApplyToRange(a,true);},ApplyToRange:function(a,c,b){switch(this.GetType()){case FCK_STYLE_BLOCK:this.ApplyToRange=this._ApplyBlockStyle;break;case FCK_STYLE_INLINE:this.ApplyToRange=this._ApplyInlineStyle;break;default:return;}this.ApplyToRange(a,c,b);},ApplyToObject:function(a){if(!a){return;}this.BuildElement(null,a);},RemoveFromSelection:function(b){var a=new FCKDomRange(b);a.MoveToSelection();this.RemoveFromRange(a,true);},RemoveFromRange:function(p,w,n){var l;var z=this._GetAttribsForComparison();var u=this._GetOverridesForComparison();if(p.CheckIsCollapsed()){var l=p.CreateBookmark(true);var a=p.GetBookmarkNode(l,true);var s=new FCKElementPath(a.parentNode);var C=[];var h=!FCKDomTools.GetNextSibling(a);var c=h||!FCKDomTools.GetPreviousSibling(a);var b;var y=-1;for(var x=0;x<s.Elements.length;x++){var q=s.Elements[x];if(this.CheckElementRemovable(q)){if(c&&!FCKDomTools.CheckIsEmptyElement(q,function(i){return(i!=a);})){b=q;y=C.length-1;}else{var k=q.nodeName.toLowerCase();if(k==this.Element){for(var t in z){if(FCKDomTools.HasAttribute(q,t)){switch(t){case"style":this._RemoveStylesFromElement(q);break;case"class":if(FCKDomTools.GetAttributeValue(q,t)!=this.GetFinalAttributeValue(t)){continue;}default:FCKDomTools.RemoveAttribute(q,t);}}}}this._RemoveOverrides(q,u[k]);if(this.GetType()==FCK_STYLE_INLINE){this._RemoveNoAttribElement(q);}}}else{if(c){C.push(q);}}c=c&&((h&&!FCKDomTools.GetNextSibling(q))||(!h&&!FCKDomTools.GetPreviousSibling(q)));if(b&&(!c||(x==s.Elements.length-1))){var f=FCKDomTools.RemoveNode(a);for(var v=0;v<=y;v++){var g=FCKDomTools.CloneElement(C[v]);g.appendChild(f);f=g;}if(h){FCKDomTools.InsertAfterNode(b,f);}else{b.parentNode.insertBefore(f,b);}c=false;b=null;}}if(w){p.SelectBookmark(l);}if(n){p.MoveToBookmark(l);}return;}p.Expand("inline_elements");l=p.CreateBookmark(true);var B=p.GetBookmarkNode(l,true);var r=p.GetBookmarkNode(l,false);p.Release(true);var s=new FCKElementPath(B);var A=s.Elements;var q;for(var x=1;x<A.length;x++){q=A[x];if(q==s.Block||q==s.BlockLimit){break;}if(this.CheckElementRemovable(q)){FCKDomTools.BreakParent(B,q,p);}}s=new FCKElementPath(r);A=s.Elements;for(var x=1;x<A.length;x++){q=A[x];if(q==s.Block||q==s.BlockLimit){break;}m=q.nodeName.toLowerCase();if(this.CheckElementRemovable(q)){FCKDomTools.BreakParent(r,q,p);}}var e=FCKDomTools.GetNextSourceNode(B,true);while(e){var d=FCKDomTools.GetNextSourceNode(e);if(e.nodeType==1){var m=e.nodeName.toLowerCase();var o=(m==this.Element);if(o){for(var t in z){if(FCKDomTools.HasAttribute(e,t)){switch(t){case"style":this._RemoveStylesFromElement(e);break;case"class":if(FCKDomTools.GetAttributeValue(e,t)!=this.GetFinalAttributeValue(t)){continue;}default:FCKDomTools.RemoveAttribute(e,t);}}}}else{o=!!u[m];}if(o){this._RemoveOverrides(e,u[m]);this._RemoveNoAttribElement(e);}}if(d==r){break;}e=d;}this._FixBookmarkStart(B);if(w){p.SelectBookmark(l);}if(n){p.MoveToBookmark(l);}},CheckElementRemovable:function(e,d){if(!e){return false;}var k=e.nodeName.toLowerCase();if(k==this.Element){if(!d&&!FCKDomTools.HasAttributes(e)){return true;}var b=this._GetAttribsForComparison();var a=(b._length==0);for(var h in b){if(h=="_length"){continue;}if(this._CompareAttributeValues(h,FCKDomTools.GetAttributeValue(e,h),(this.GetFinalAttributeValue(h)||""))){a=true;if(!d){break;}}else{a=false;if(d){return false;}}}if(a){return true;}}var c=this._GetOverridesForComparison()[k];if(c){if(!(b=c.Attributes)){return true;}for(var f=0;f<b.length;f++){var g=b[f][0];if(FCKDomTools.HasAttribute(e,g)){var j=b[f][1];if(j==null||(typeof j=="string"&&FCKDomTools.GetAttributeValue(e,g)==j)||j.test(FCKDomTools.GetAttributeValue(e,g))){return true;}}}}return false;},CheckActive:function(c){switch(this.GetType()){case FCK_STYLE_BLOCK:return this.CheckElementRemovable(c.Block||c.BlockLimit,true);case FCK_STYLE_INLINE:var d=c.Elements;for(var b=0;b<d.length;b++){var a=d[b];if(a==c.Block||a==c.BlockLimit){continue;}if(this.CheckElementRemovable(a,true)){return true;}}}return false;},RemoveFromElement:function(d){var h=this._GetAttribsForComparison();var g=this._GetOverridesForComparison();var a=d.getElementsByTagName(this.Element);for(var c=a.length-1;c>=0;c--){var e=a[c];for(var b in h){if(FCKDomTools.HasAttribute(e,b)){switch(b){case"style":this._RemoveStylesFromElement(e);break;case"class":if(FCKDomTools.GetAttributeValue(e,b)!=this.GetFinalAttributeValue(b)){continue;}default:FCKDomTools.RemoveAttribute(e,b);}}}this._RemoveOverrides(e,g[this.Element]);this._RemoveNoAttribElement(e);}for(var f in g){if(f!=this.Element){a=d.getElementsByTagName(f);for(var c=a.length-1;c>=0;c--){var e=a[c];this._RemoveOverrides(e,g[f]);this._RemoveNoAttribElement(e);}}}},_RemoveStylesFromElement:function(a){var d=a.style.cssText;var c=this.GetFinalStyleValue();if(d.length>0&&c.length==0){return;}c="(^|;)\\s*("+c.replace(/\s*([^ ]+):.*?(;|$)/g,"$1|").replace(/\|$/,"")+"):[^;]+";var b=new RegExp(c,"gi");d=d.replace(b,"").Trim();if(d.length==0||d==";"){FCKDomTools.RemoveAttribute(a,"style");}else{a.style.cssText=d.replace(b,"");}},_RemoveOverrides:function(e,d){var a=d&&d.Attributes;if(a){for(var c=0;c<a.length;c++){var f=a[c][0];if(FCKDomTools.HasAttribute(e,f)){var b=a[c][1];if(b==null||(b.test&&b.test(FCKDomTools.GetAttributeValue(e,f)))||(typeof b=="string"&&FCKDomTools.GetAttributeValue(e,f)==b)){FCKDomTools.RemoveAttribute(e,f);}}}}},_RemoveNoAttribElement:function(a){if(!FCKDomTools.HasAttributes(a)){var c=a.firstChild;var b=a.lastChild;FCKDomTools.RemoveNode(a,true);this._MergeSiblings(c);if(c!=b){this._MergeSiblings(b);}}},BuildElement:function(d,c){var e=c||d.createElement(this.Element);var f=this._StyleDesc.Attributes;var b;if(f){for(var a in f){b=this.GetFinalAttributeValue(a);if(a.toLowerCase()=="class"){e.className=b;}else{e.setAttribute(a,b);}}}if(this._GetStyleText().length>0){e.style.cssText=this.GetFinalStyleValue();}return e;},_CompareAttributeValues:function(c,b,a){if(c=="style"&&b&&a){b=b.replace(/;$/,"").toLowerCase();a=a.replace(/;$/,"").toLowerCase();}return(b==a||((b===null||b==="")&&(a===null||a==="")));},GetFinalAttributeValue:function(b){var a=this._StyleDesc.Attributes;var a=a?a[b]:null;if(!a&&b=="style"){return this.GetFinalStyleValue();}if(a&&this._Variables){a=a.Replace(FCKRegexLib.StyleVariableAttName,this._GetVariableReplace,this);}return a;},GetFinalStyleValue:function(){var a=this._GetStyleText();if(a.length>0&&this._Variables){a=a.Replace(FCKRegexLib.StyleVariableAttName,this._GetVariableReplace,this);a=FCKTools.NormalizeCssText(a);}return a;},_GetVariableReplace:function(){return this._Variables[arguments[2]]||arguments[0];},SetVariable:function(a,b){var c=this._Variables;if(!c){c=this._Variables={};}this._Variables[a]=b;},_FromPre:function(b,c,f){var e=c.innerHTML;e=e.replace(/(\r\n|\r)/g,"\n");e=e.replace(/^[ \t]*\n/,"");e=e.replace(/\n$/,"");e=e.replace(/^[ \t]+|[ \t]+$/g,function(g,i,h){if(g.length==1){return"&nbsp;";}else{if(i==0){return new Array(g.length).join("&nbsp;")+" ";}else{return" "+new Array(g.length).join("&nbsp;");}}});var d=new FCKHtmlIterator(e);var a=[];d.Each(function(g,h){if(!g){h=h.replace(/\n/g,"<br>");h=h.replace(/[ \t]{2,}/g,function(i){return new Array(i.length).join("&nbsp;")+" ";});}a.push(h);});f.innerHTML=a.join("");return f;},_ToPre:function(c,d,g){var f=d.innerHTML.Trim();f=f.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"<br />");var e=new FCKHtmlIterator(f);var b=[];e.Each(function(h,i){if(!h){i=i.replace(/([ \t\n\r]+|&nbsp;)/g," ");}else{if(h&&i=="<br />"){i="\n";}}b.push(i);});if(FCKBrowserInfo.IsIE){var a=c.createElement("div");a.appendChild(g);g.outerHTML="<pre>\n"+b.join("")+"</pre>";g=a.removeChild(a.firstChild);}else{g.innerHTML=b.join("");}return g;},_CheckAndMergePre:function(a,b){if(a!=FCKDomTools.GetPreviousSourceElement(b,true)){return;}var c=a.innerHTML.replace(/\n$/,"")+"\n\n"+b.innerHTML.replace(/^\n/,"");if(FCKBrowserInfo.IsIE){b.outerHTML="<pre>"+c+"</pre>";}else{b.innerHTML=c;}FCKDomTools.RemoveNode(a);},_CheckAndSplitPre:function(d){var a;var c=d.firstChild;c=c&&c.nextSibling;while(c){var b=c.nextSibling;if(b&&b.nextSibling&&c.nodeName.IEquals("br")&&b.nodeName.IEquals("br")){FCKDomTools.RemoveNode(c);c=b.nextSibling;FCKDomTools.RemoveNode(b);a=FCKDomTools.InsertAfterNode(a||d,FCKDomTools.CloneElement(d));continue;}if(a){c=c.previousSibling;FCKDomTools.MoveNode(c.nextSibling,a);}c=c.nextSibling;}},_ApplyBlockStyle:function(g,e,d){var j;if(e){j=g.CreateBookmark();}var f=new FCKDomRangeIterator(g);f.EnforceRealBlocks=true;var c;var m=g.Window.document;var l;while((c=f.GetNextParagraph())){var k=this.BuildElement(m);var a=k.nodeName.IEquals("pre");var i=c.nodeName.IEquals("pre");var b=a&&!i;var h=!a&&i;if(b){k=this._ToPre(m,c,k);}else{if(h){k=this._FromPre(m,c,k);}else{FCKDomTools.MoveChildren(c,k);}}c.parentNode.insertBefore(k,c);FCKDomTools.RemoveNode(c);if(a){if(l){this._CheckAndMergePre(l,k);}l=k;}else{if(h){this._CheckAndSplitPre(k);}}}if(e){g.SelectBookmark(j);}if(d){g.MoveToBookmark(j);}},_ApplyInlineStyle:function(j,l,h){var r=j.Window.document;if(j.CheckIsCollapsed()){var b=this.BuildElement(r);j.InsertNode(b);j.MoveToPosition(b,2);j.Select();return;}var g=this.Element;var p=FCK.DTD[g]||FCK.DTD.span;var m=this._GetAttribsForComparison();var o;j.Expand("inline_elements");var e=j.CreateBookmark(true);var q=j.GetBookmarkNode(e,true);var k=j.GetBookmarkNode(e,false);j.Release(true);var c=FCKDomTools.GetNextSourceNode(q,true);while(c){var n=false;var d=c.nodeType;var a=d==1?c.nodeName.toLowerCase():null;if(!a||p[a]){if((FCK.DTD[c.parentNode.nodeName.toLowerCase()]||FCK.DTD.span)[g]||!FCK.DTD[g]){if(!j.CheckHasRange()){j.SetStart(c,3);}if(d!=1||c.childNodes.length==0){var i=c;var f=i.parentNode;while(i==f.lastChild&&p[f.nodeName.toLowerCase()]){i=f;}j.SetEnd(i,4);if(i==i.parentNode.lastChild&&!p[i.parentNode.nodeName.toLowerCase()]){n=true;}}else{j.SetEnd(c,3);}}else{n=true;}}else{n=true;}c=FCKDomTools.GetNextSourceNode(c);if(c==k){c=null;n=true;}if(n&&j.CheckHasRange()&&!j.CheckIsCollapsed()){o=this.BuildElement(r);j.ExtractContents().AppendTo(o);if(o.innerHTML.RTrim().length>0){j.InsertNode(o);this.RemoveFromElement(o);this._MergeSiblings(o,this._GetAttribsForComparison());if(!FCKBrowserInfo.IsIE){o.normalize();}}j.Release(true);}}this._FixBookmarkStart(q);if(l){j.SelectBookmark(e);}if(h){j.MoveToBookmark(e);}},_FixBookmarkStart:function(a){var b;while((b=a.nextSibling)){if(b.nodeType==1&&FCKListsLib.InlineNonEmptyElements[b.nodeName.toLowerCase()]){if(!b.firstChild){FCKDomTools.RemoveNode(b);}else{FCKDomTools.MoveNode(a,b,true);}continue;}if(b.nodeType==3&&b.length==0){FCKDomTools.RemoveNode(b);continue;}break;}},_MergeSiblings:function(a,b){if(!a||a.nodeType!=1||!FCKListsLib.InlineNonEmptyElements[a.nodeName.toLowerCase()]){return;}this._MergeNextSibling(a,b);this._MergePreviousSibling(a,b);},_MergeNextSibling:function(b,d){var c=b.nextSibling;var a=(c&&c.nodeType==1&&c.getAttribute("_fck_bookmark"));if(a){c=c.nextSibling;}if(c&&c.nodeType==1&&c.nodeName==b.nodeName){if(!d){d=this._CreateElementAttribsForComparison(b);}if(this._CheckAttributesMatch(c,d)){var e=b.lastChild;if(a){FCKDomTools.MoveNode(b.nextSibling,b);}FCKDomTools.MoveChildren(c,b);FCKDomTools.RemoveNode(c);if(e){this._MergeNextSibling(e);}}}},_MergePreviousSibling:function(b,d){var c=b.previousSibling;var a=(c&&c.nodeType==1&&c.getAttribute("_fck_bookmark"));if(a){c=c.previousSibling;}if(c&&c.nodeType==1&&c.nodeName==b.nodeName){if(!d){d=this._CreateElementAttribsForComparison(b);}if(this._CheckAttributesMatch(c,d)){var e=b.firstChild;if(a){FCKDomTools.MoveNode(b.previousSibling,b,true);}FCKDomTools.MoveChildren(c,b,true);FCKDomTools.RemoveNode(c);if(e){this._MergePreviousSibling(e);}}}},_GetStyleText:function(){var b=this._StyleDesc.Styles;var a=(this._StyleDesc.Attributes?this._StyleDesc.Attributes["style"]||"":"");if(a.length>0){a+=";";}for(var c in b){a+=c+":"+b[c]+";";}if(a.length>0&&!(/#\(/.test(a))){a=FCKTools.NormalizeCssText(a);}return(this._GetStyleText=function(){return a;})();},_GetAttribsForComparison:function(){var c=this._GetAttribsForComparison_$;if(c){return c;}c=new Object();var b=this._StyleDesc.Attributes;if(b){for(var a in b){c[a.toLowerCase()]=b[a].toLowerCase();}}if(this._GetStyleText().length>0){c["style"]=this._GetStyleText().toLowerCase();}FCKTools.AppendLengthProperty(c,"_length");return(this._GetAttribsForComparison_$=c);},_GetOverridesForComparison:function(){var g=this._GetOverridesForComparison_$;if(g){return g;}g=new Object();var e=this._StyleDesc.Overrides;if(e){if(!FCKTools.IsArray(e)){e=[e];}for(var c=0;c<e.length;c++){var a=e[c];var j;var d;var h;if(typeof a=="string"){j=a.toLowerCase();}else{j=a.Element?a.Element.toLowerCase():this.Element;h=a.Attributes;}d=g[j]||(g[j]={});if(h){var b=(d.Attributes=d.Attributes||new Array());for(var f in h){b.push([f.toLowerCase(),h[f]]);}}}}return(this._GetOverridesForComparison_$=g);},_CreateElementAttribsForComparison:function(d){var e=new Object();var c=0;for(var b=0;b<d.attributes.length;b++){var a=d.attributes[b];if(a.specified){e[a.nodeName.toLowerCase()]=FCKDomTools.GetAttributeValue(d,a).toLowerCase();c++;}}e._length=c;return e;},_CheckAttributesMatch:function(f,g){var d=f.attributes;var c=0;for(var e=0;e<d.length;e++){var b=d[e];if(b.specified){var h=b.nodeName.toLowerCase();var a=g[h];if(!a){break;}if(a!=FCKDomTools.GetAttributeValue(f,b).toLowerCase()){break;}c++;}}return(c==g._length);}};