var FCKDomRange=function(a){this.Window=a;this._Cache={};};FCKDomRange.prototype={_UpdateElementInfo:function(){var e=this._Range;if(!e){this.Release(true);}else{var d=e.startContainer;var c=new FCKElementPath(d);this.StartNode=d.nodeType==3?d:d.childNodes[e.startOffset];this.StartContainer=d;this.StartBlock=c.Block;this.StartBlockLimit=c.BlockLimit;if(e.collapsed){this.EndNode=this.StartNode;this.EndContainer=this.StartContainer;this.EndBlock=this.StartBlock;this.EndBlockLimit=this.StartBlockLimit;}else{var b=e.endContainer;if(d!=b){c=new FCKElementPath(b);}var a=b;if(e.endOffset==0){while(a&&!a.previousSibling){a=a.parentNode;}if(a){a=a.previousSibling;}}else{if(a.nodeType==1){a=a.childNodes[e.endOffset-1];}}this.EndNode=a;this.EndContainer=b;this.EndBlock=c.Block;this.EndBlockLimit=c.BlockLimit;}}this._Cache={};},CreateRange:function(){return new FCKW3CRange(this.Window.document);},DeleteContents:function(){if(this._Range){this._Range.deleteContents();this._UpdateElementInfo();}},ExtractContents:function(){if(this._Range){var a=this._Range.extractContents();this._UpdateElementInfo();return a;}return null;},CheckIsCollapsed:function(){if(this._Range){return this._Range.collapsed;}return false;},Collapse:function(a){if(this._Range){this._Range.collapse(a);}this._UpdateElementInfo();},Clone:function(){var a=FCKTools.CloneObject(this);if(this._Range){a._Range=this._Range.cloneRange();}return a;},MoveToNodeContents:function(a){if(!this._Range){this._Range=this.CreateRange();}this._Range.selectNodeContents(a);this._UpdateElementInfo();},MoveToElementStart:function(a){this.SetStart(a,1);this.SetEnd(a,1);},MoveToElementEditStart:function(a){var b;while(a&&a.nodeType==1){if(FCKDomTools.CheckIsEditable(a)){b=a;}else{if(b){break;}}a=a.firstChild;}if(b){this.MoveToElementStart(b);}},InsertNode:function(a){if(this._Range){this._Range.insertNode(a);}},CheckIsEmpty:function(){if(this.CheckIsCollapsed()){return true;}var a=this.Window.document.createElement("div");this._Range.cloneContents().AppendTo(a);FCKDomTools.TrimNode(a);return(a.innerHTML.length==0);},CheckStartOfBlock:function(){var d=this._Cache;var c=d.IsStartOfBlock;if(c!=undefined){return c;}var g=this.StartBlock||this.StartBlockLimit;var b=this._Range.startContainer;var f=this._Range.startOffset;var e;if(f>0){if(b.nodeType==3){var a=b.nodeValue.substr(0,f).Trim();if(a.length!=0){return d.IsStartOfBlock=false;}}else{e=b.childNodes[f-1];}}if(!e){e=FCKDomTools.GetPreviousSourceNode(b,true,null,g);}while(e){switch(e.nodeType){case 1:if(!FCKListsLib.InlineChildReqElements[e.nodeName.toLowerCase()]){return d.IsStartOfBlock=false;}break;case 3:if(e.nodeValue.Trim().length>0){return d.IsStartOfBlock=false;}}e=FCKDomTools.GetPreviousSourceNode(e,false,null,g);}return d.IsStartOfBlock=true;},CheckEndOfBlock:function(i){var b=this._Cache.IsEndOfBlock;if(b!=undefined){return b;}var d=this.EndBlock||this.EndBlockLimit;var a=this._Range.endContainer;var f=this._Range.endOffset;var c;if(a.nodeType==3){var e=a.nodeValue;if(f<e.length){e=e.substr(f);if(e.Trim().length!=0){return this._Cache.IsEndOfBlock=false;}}}else{c=a.childNodes[f];}if(!c){c=FCKDomTools.GetNextSourceNode(a,true,null,d);}var g=false;while(c){switch(c.nodeType){case 1:var h=c.nodeName.toLowerCase();if(FCKListsLib.InlineChildReqElements[h]){break;}if(h=="br"&&!g){g=true;break;}return this._Cache.IsEndOfBlock=false;case 3:if(c.nodeValue.Trim().length>0){return this._Cache.IsEndOfBlock=false;}}c=FCKDomTools.GetNextSourceNode(c,false,null,d);}if(i){this.Select();}return this._Cache.IsEndOfBlock=true;},CreateBookmark:function(e){var f={StartId:(new Date()).valueOf()+Math.floor(Math.random()*1000)+"S",EndId:(new Date()).valueOf()+Math.floor(Math.random()*1000)+"E"};var b=this.Window.document;var d;var a;var c;if(!this.CheckIsCollapsed()){a=b.createElement("span");a.style.display="none";a.id=f.EndId;a.setAttribute("_fck_bookmark",true);a.innerHTML="&nbsp;";c=this.Clone();c.Collapse(false);c.InsertNode(a);}d=b.createElement("span");d.style.display="none";d.id=f.StartId;d.setAttribute("_fck_bookmark",true);d.innerHTML="&nbsp;";c=this.Clone();c.Collapse(true);c.InsertNode(d);if(e){f.StartNode=d;f.EndNode=a;}if(a){this.SetStart(d,4);this.SetEnd(a,3);}else{this.MoveToPosition(d,4);}return f;},GetBookmarkNode:function(a,c){var b=this.Window.document;if(c){return a.StartNode||b.getElementById(a.StartId);}else{return a.EndNode||b.getElementById(a.EndId);}},MoveToBookmark:function(c,b){var d=this.GetBookmarkNode(c,true);var a=this.GetBookmarkNode(c,false);this.SetStart(d,3);if(!b){FCKDomTools.RemoveNode(d);}if(a){this.SetEnd(a,3);if(!b){FCKDomTools.RemoveNode(a);}}else{this.Collapse(true);}this._UpdateElementInfo();},CreateBookmark2:function(){if(!this._Range){return{"Start":0,"End":0};}var d={"Start":[this._Range.startOffset],"End":[this._Range.endOffset]};var a=this._Range.startContainer.previousSibling;var f=this._Range.endContainer.previousSibling;var e=this._Range.startContainer;var b=this._Range.endContainer;while(a&&a.nodeType==3&&e.nodeType==3){d.Start[0]+=a.length;e=a;a=a.previousSibling;}while(f&&f.nodeType==3&&b.nodeType==3){d.End[0]+=f.length;b=f;f=f.previousSibling;}if(e.nodeType==1&&e.childNodes[d.Start[0]]&&e.childNodes[d.Start[0]].nodeType==3){var c=e.childNodes[d.Start[0]];var g=0;while(c.previousSibling&&c.previousSibling.nodeType==3){c=c.previousSibling;g+=c.length;}e=c;d.Start[0]=g;}if(b.nodeType==1&&b.childNodes[d.End[0]]&&b.childNodes[d.End[0]].nodeType==3){var c=b.childNodes[d.End[0]];var g=0;while(c.previousSibling&&c.previousSibling.nodeType==3){c=c.previousSibling;g+=c.length;}b=c;d.End[0]=g;}d.Start=FCKDomTools.GetNodeAddress(e,true).concat(d.Start);d.End=FCKDomTools.GetNodeAddress(b,true).concat(d.End);return d;},MoveToBookmark2:function(d){var b=FCKDomTools.GetNodeFromAddress(this.Window.document,d.Start.slice(0,-1),true);var e=FCKDomTools.GetNodeFromAddress(this.Window.document,d.End.slice(0,-1),true);this.Release(true);this._Range=new FCKW3CRange(this.Window.document);var a=d.Start[d.Start.length-1];var c=d.End[d.End.length-1];while(b.nodeType==3&&a>b.length){if(!b.nextSibling||b.nextSibling.nodeType!=3){break;}a-=b.length;b=b.nextSibling;}while(e.nodeType==3&&c>e.length){if(!e.nextSibling||e.nextSibling.nodeType!=3){break;}c-=e.length;e=e.nextSibling;}this._Range.setStart(b,a);this._Range.setEnd(e,c);this._UpdateElementInfo();},MoveToPosition:function(b,a){this.SetStart(b,a);this.Collapse(true);},SetStart:function(c,a,b){var d=this._Range;if(!d){d=this._Range=this.CreateRange();}switch(a){case 1:d.setStart(c,0);break;case 2:d.setStart(c,c.childNodes.length);break;case 3:d.setStartBefore(c);break;case 4:d.setStartAfter(c);}if(!b){this._UpdateElementInfo();}},SetEnd:function(c,a,b){var d=this._Range;if(!d){d=this._Range=this.CreateRange();}switch(a){case 1:d.setEnd(c,0);break;case 2:d.setEnd(c,c.childNodes.length);break;case 3:d.setEndBefore(c);break;case 4:d.setEndAfter(c);}if(!b){this._UpdateElementInfo();}},Expand:function(c){var f,a;switch(c){case"inline_elements":if(this._Range.startOffset==0){f=this._Range.startContainer;if(f.nodeType!=1){f=f.previousSibling?null:f.parentNode;}if(f){while(FCKListsLib.InlineNonEmptyElements[f.nodeName.toLowerCase()]){this._Range.setStartBefore(f);if(f!=f.parentNode.firstChild){break;}f=f.parentNode;}}}f=this._Range.endContainer;var e=this._Range.endOffset;if((f.nodeType==3&&e>=f.nodeValue.length)||(f.nodeType==1&&e>=f.childNodes.length)||(f.nodeType!=1&&f.nodeType!=3)){if(f.nodeType!=1){f=f.nextSibling?null:f.parentNode;}if(f){while(FCKListsLib.InlineNonEmptyElements[f.nodeName.toLowerCase()]){this._Range.setEndAfter(f);if(f!=f.parentNode.lastChild){break;}f=f.parentNode;}}}break;case"block_contents":case"list_contents":var d=FCKListsLib.BlockBoundaries;if(c=="list_contents"||FCKConfig.EnterMode=="br"){d=FCKListsLib.ListBoundaries;}if(this.StartBlock&&FCKConfig.EnterMode!="br"&&c=="block_contents"){this.SetStart(this.StartBlock,1);}else{f=this._Range.startContainer;if(f.nodeType==1){var b=f.childNodes[this._Range.startOffset];if(b){f=FCKDomTools.GetPreviousSourceNode(b,true);}else{f=f.lastChild||f;}}while(f&&(f.nodeType!=1||(f!=this.StartBlockLimit&&!d[f.nodeName.toLowerCase()]))){this._Range.setStartBefore(f);f=f.previousSibling||f.parentNode;}}if(this.EndBlock&&FCKConfig.EnterMode!="br"&&c=="block_contents"&&this.EndBlock.nodeName.toLowerCase()!="li"){this.SetEnd(this.EndBlock,2);}else{f=this._Range.endContainer;if(f.nodeType==1){f=f.childNodes[this._Range.endOffset]||f.lastChild;}while(f&&(f.nodeType!=1||(f!=this.StartBlockLimit&&!d[f.nodeName.toLowerCase()]))){this._Range.setEndAfter(f);f=f.nextSibling||f.parentNode;}if(f&&f.nodeName.toLowerCase()=="br"){this._Range.setEndAfter(f);}}this._UpdateElementInfo();}},SplitBlock:function(e){var h=e||FCKConfig.EnterMode;if(!this._Range){this.MoveToSelection();}if(this.StartBlockLimit==this.EndBlockLimit){var d=this.StartBlock;var a=this.EndBlock;var c=null;if(h!="br"){if(!d){d=this.FixBlock(true,h);a=this.EndBlock;}if(!a){a=this.FixBlock(false,h);}}var b=(d!=null&&this.CheckStartOfBlock());var f=(a!=null&&this.CheckEndOfBlock());if(!this.CheckIsEmpty()){this.DeleteContents();}if(d&&a&&d==a){if(f){c=new FCKElementPath(this.StartContainer);this.MoveToPosition(a,4);a=null;}else{if(b){c=new FCKElementPath(this.StartContainer);this.MoveToPosition(d,3);d=null;}else{this.SetEnd(d,2);var g=this.ExtractContents();a=d.cloneNode(false);a.removeAttribute("id",false);g.AppendTo(a);FCKDomTools.InsertAfterNode(d,a);this.MoveToPosition(d,4);if(FCKBrowserInfo.IsGecko&&!d.nodeName.IEquals(["ul","ol"])){FCKTools.AppendBogusBr(d);}}}}return{PreviousBlock:d,NextBlock:a,WasStartOfBlock:b,WasEndOfBlock:f,ElementPath:c};}return null;},FixBlock:function(a,d){var c=this.CreateBookmark();this.Collapse(a);this.Expand("block_contents");var b=this.Window.document.createElement(d);this.ExtractContents().AppendTo(b);FCKDomTools.TrimNode(b);if(FCKDomTools.CheckIsEmptyElement(b,function(e){return e.getAttribute("_fck_bookmark")!="true";})&&FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(b);}this.InsertNode(b);this.MoveToBookmark(c);return b;},Release:function(a){if(!a){this.Window=null;}this.StartNode=null;this.StartContainer=null;this.StartBlock=null;this.StartBlockLimit=null;this.EndNode=null;this.EndContainer=null;this.EndBlock=null;this.EndBlockLimit=null;this._Range=null;this._Cache=null;},CheckHasRange:function(){return !!this._Range;},GetTouchedStartNode:function(){var b=this._Range;var a=b.startContainer;if(b.collapsed||a.nodeType!=1){return a;}return a.childNodes[b.startOffset]||a;},GetTouchedEndNode:function(){var b=this._Range;var a=b.endContainer;if(b.collapsed||a.nodeType!=1){return a;}return a.childNodes[b.endOffset-1]||a;}};