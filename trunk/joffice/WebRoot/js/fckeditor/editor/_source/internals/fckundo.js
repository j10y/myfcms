var FCKUndo=new Object();FCKUndo.SavedData=new Array();FCKUndo.CurrentIndex=-1;FCKUndo.TypesCount=0;FCKUndo.Changed=false;FCKUndo.MaxTypes=25;FCKUndo.Typing=false;FCKUndo.SaveLocked=false;FCKUndo._GetBookmark=function(){FCKSelection.Restore();var b=new FCKDomRange(FCK.EditorWindow);try{b.MoveToSelection();}catch(d){return null;}if(FCKBrowserInfo.IsIE){var c=b.CreateBookmark();var a=FCK.EditorDocument.body.innerHTML;b.MoveToBookmark(c);return[c,a];}return b.CreateBookmark2();};FCKUndo._SelectBookmark=function(b){if(!b){return;}var a=new FCKDomRange(FCK.EditorWindow);if(b instanceof Object){if(FCKBrowserInfo.IsIE){a.MoveToBookmark(b[0]);}else{a.MoveToBookmark2(b);}try{a.Select();}catch(c){a.MoveToPosition(FCK.EditorDocument.body,4);a.Select();}}};FCKUndo._CompareCursors=function(c,b){for(var a=0;a<Math.min(c.length,b.length);a++){if(c[a]<b[a]){return -1;}else{if(c[a]>b[a]){return 1;}}}if(c.length<b.length){return -1;}else{if(c.length>b.length){return 1;}}return 0;};FCKUndo._CheckIsBookmarksEqual=function(c,a){if(!(c&&a)){return false;}if(FCKBrowserInfo.IsIE){var f=c[1].search(c[0].StartId);var e=a[1].search(a[0].StartId);var d=c[1].search(c[0].EndId);var b=a[1].search(a[0].EndId);return f==e&&d==b;}else{return this._CompareCursors(c.Start,a.Start)==0&&this._CompareCursors(c.End,a.End)==0;}};FCKUndo.SaveUndoStep=function(){if(FCK.EditMode!=FCK_EDITMODE_WYSIWYG||this.SaveLocked){return;}if(this.SavedData.length){this.Changed=true;}var b=FCK.EditorDocument.body.innerHTML;var a=this._GetBookmark();this.SavedData=this.SavedData.slice(0,this.CurrentIndex+1);if(this.CurrentIndex>0&&b==this.SavedData[this.CurrentIndex][0]&&this._CheckIsBookmarksEqual(a,this.SavedData[this.CurrentIndex][1])){return;}else{if(this.CurrentIndex==0&&this.SavedData.length&&b==this.SavedData[0][0]){this.SavedData[0][1]=a;return;}}if(this.CurrentIndex+1>=FCKConfig.MaxUndoLevels){this.SavedData.shift();}else{this.CurrentIndex++;}this.SavedData[this.CurrentIndex]=[b,a];FCK.Events.FireEvent("OnSelectionChange");};FCKUndo.CheckUndoState=function(){return(this.Changed||this.CurrentIndex>0);};FCKUndo.CheckRedoState=function(){return(this.CurrentIndex<(this.SavedData.length-1));};FCKUndo.Undo=function(){if(this.CheckUndoState()){if(this.CurrentIndex==(this.SavedData.length-1)){this.SaveUndoStep();}this._ApplyUndoLevel(--this.CurrentIndex);FCK.Events.FireEvent("OnSelectionChange");}};FCKUndo.Redo=function(){if(this.CheckRedoState()){this._ApplyUndoLevel(++this.CurrentIndex);FCK.Events.FireEvent("OnSelectionChange");}};FCKUndo._ApplyUndoLevel=function(b){var a=this.SavedData[b];if(!a){return;}if(FCKBrowserInfo.IsIE){if(a[1]&&a[1][1]){FCK.SetInnerHtml(a[1][1]);}else{FCK.SetInnerHtml(a[0]);}}else{FCK.EditorDocument.body.innerHTML=a[0];}this._SelectBookmark(a[1]);this.TypesCount=0;this.Changed=false;this.Typing=false;};