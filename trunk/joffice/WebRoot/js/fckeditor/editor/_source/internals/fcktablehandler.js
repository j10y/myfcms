var FCKTableHandler=new Object();FCKTableHandler.InsertRow=function(b){var a=FCKSelection.MoveToAncestorNode("TR");if(!a){return;}var c=a.cloneNode(true);a.parentNode.insertBefore(c,a);FCKTableHandler.ClearRow(b?c:a);};FCKTableHandler.DeleteRows=function(f){if(!f){var c=FCKTableHandler.GetSelectedCells();var e=new Array();for(var d=0;d<c.length;d++){var b=c[d].parentNode;e[b.rowIndex]=b;}for(var d=e.length;d>=0;d--){if(e[d]){FCKTableHandler.DeleteRows(e[d]);}}return;}var a=FCKTools.GetElementAscensor(f,"TABLE");if(a.rows.length==1){FCKTableHandler.DeleteTable(a);return;}f.parentNode.removeChild(f);};FCKTableHandler.DeleteTable=function(a){if(!a){a=FCKSelection.GetSelectedElement();if(!a||a.tagName!="TABLE"){a=FCKSelection.MoveToAncestorNode("TABLE");}}if(!a){return;}FCKSelection.SelectNode(a);FCKSelection.Collapse();if(a.parentNode.childNodes.length==1){a.parentNode.parentNode.removeChild(a.parentNode);}else{a.parentNode.removeChild(a);}};FCKTableHandler.InsertColumn=function(f){var e=null;var c=this.GetSelectedCells();if(c&&c.length){e=c[f?0:(c.length-1)];}if(!e){return;}var b=FCKTools.GetElementAscensor(e,"TABLE");var h=e.cellIndex;for(var g=0;g<b.rows.length;g++){var a=b.rows[g];if(a.cells.length<(h+1)){continue;}e=a.cells[h].cloneNode(false);if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(e);}var d=a.cells[h];a.insertBefore(e,(f?d:d.nextSibling));}};FCKTableHandler.DeleteColumns=function(d){if(!d){var c=FCKTableHandler.GetSelectedCells();for(var e=c.length;e>=0;e--){if(c[e]){FCKTableHandler.DeleteColumns(c[e]);}}return;}if(!d){return;}var b=FCKTools.GetElementAscensor(d,"TABLE");var f=d.cellIndex;for(var e=b.rows.length-1;e>=0;e--){var a=b.rows[e];if(f==0&&a.cells.length==1){FCKTableHandler.DeleteRows(a);continue;}if(a.cells[f]){a.removeChild(a.cells[f]);}}};FCKTableHandler.InsertCell=function(a,d){var c=null;var b=this.GetSelectedCells();if(b&&b.length){c=b[d?0:(b.length-1)];}if(!c){return null;}var e=FCK.EditorDocument.createElement("TD");if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(e);}if(!d&&c.cellIndex==c.parentNode.cells.length-1){c.parentNode.appendChild(e);}else{c.parentNode.insertBefore(e,d?c:c.nextSibling);}return e;};FCKTableHandler.DeleteCell=function(a){if(a.parentNode.cells.length==1){FCKTableHandler.DeleteRows(a.parentNode);return;}a.parentNode.removeChild(a);};FCKTableHandler.DeleteCells=function(){var a=FCKTableHandler.GetSelectedCells();for(var b=a.length-1;b>=0;b--){FCKTableHandler.DeleteCell(a[b]);}};FCKTableHandler._MarkCells=function(b,a){for(var c=0;c<b.length;c++){b[c][a]=true;}};FCKTableHandler._UnmarkCells=function(b,a){for(var c=0;c<b.length;c++){FCKDomTools.ClearElementJSProperty(b[c],a);}};FCKTableHandler._ReplaceCellsByMarker=function(e,b,a){for(var d=0;d<e.length;d++){for(var c=0;c<e[d].length;c++){if(e[d][c][b]){e[d][c]=a;}}}};FCKTableHandler._GetMarkerGeometry=function(b,a,d,f){var g=0;var j=0;var h=0;var e=0;for(var c=d;b[a][c]&&b[a][c][f];c++){g++;}for(var c=d-1;b[a][c]&&b[a][c][f];c--){g++;h++;}for(var c=a;b[c]&&b[c][d]&&b[c][d][f];c++){j++;}for(var c=a-1;b[c]&&b[c][d]&&b[c][d][f];c--){j++;e++;}return{"width":g,"height":j,"x":h,"y":e};};FCKTableHandler.CheckIsSelectionRectangular=function(){var j=FCKTableHandler.GetSelectedCells();if(j.length<1){return false;}for(var d=0;d<j.length;d++){if(j[d].parentNode.parentNode!=j[0].parentNode.parentNode){return false;}}this._MarkCells(j,"_CellSelected");var b=this._CreateTableMap(j[0]);var a=j[0].parentNode.rowIndex;var c=this._GetCellIndexSpan(b,a,j[0]);var h=this._GetMarkerGeometry(b,a,c,"_CellSelected");var k=c-h.x;var f=a-h.y;if(h.width>=h.height){for(c=k;c<k+h.width;c++){a=f+(c-k)%h.height;if(!b[a]||!b[a][c]){this._UnmarkCells(j,"_CellSelected");return false;}var e=this._GetMarkerGeometry(b,a,c,"_CellSelected");if(e.width!=h.width||e.height!=h.height){this._UnmarkCells(j,"_CellSelected");return false;}}}else{for(a=f;a<f+h.height;a++){c=k+(a-f)%h.width;if(!b[a]||!b[a][c]){this._UnmarkCells(j,"_CellSelected");return false;}var e=this._GetMarkerGeometry(b,a,c,"_CellSelected");if(e.width!=h.width||e.height!=h.height){this._UnmarkCells(j,"_CellSelected");return false;}}}this._UnmarkCells(j,"_CellSelected");return true;};FCKTableHandler.MergeCells=function(){var o=this.GetSelectedCells();if(o.length<2){return;}var c=o[0];var e=this._CreateTableMap(c);var b=c.parentNode.rowIndex;var l=this._GetCellIndexSpan(e,b,c);this._MarkCells(o,"_SelectedCells");var a=this._GetMarkerGeometry(e,b,l,"_SelectedCells");var p=l-a.x;var m=b-a.y;var h=FCKTools.GetElementDocument(c).createDocumentFragment();for(var k=0;k<a.height;k++){var d=0;for(var g=0;g<a.width;g++){var n=e[m+k][p+g];while(n.childNodes.length>0){var f=n.removeChild(n.firstChild);if(f.nodeType!=1||(f.getAttribute("type",2)!="_moz"&&f.getAttribute("_moz_dirty")!=null)){h.appendChild(f);d++;}}}if(d>0){h.appendChild(FCK.EditorDocument.createElement("br"));}}this._ReplaceCellsByMarker(e,"_SelectedCells",c);this._UnmarkCells(o,"_SelectedCells");this._InstallTableMap(e,c.parentNode.parentNode.parentNode);c.appendChild(h);if(FCKBrowserInfo.IsGeckoLike&&(!c.firstChild)){FCKTools.AppendBogusBr(c);}this._MoveCaretToCell(c,false);};FCKTableHandler.MergeRight=function(){var d=this.GetMergeRightTarget();if(d==null){return;}var c=d.refCell;var e=d.tableMap;var a=d.nextCell;var b=FCK.EditorDocument.createDocumentFragment();while(a&&a.childNodes&&a.childNodes.length>0){b.appendChild(a.removeChild(a.firstChild));}a.parentNode.removeChild(a);c.appendChild(b);this._MarkCells([a],"_Replace");this._ReplaceCellsByMarker(e,"_Replace",c);this._InstallTableMap(e,c.parentNode.parentNode.parentNode);this._MoveCaretToCell(c,false);};FCKTableHandler.MergeDown=function(){var d=this.GetMergeDownTarget();if(d==null){return;}var c=d.refCell;var e=d.tableMap;var a=d.nextCell;var b=FCKTools.GetElementDocument(c).createDocumentFragment();while(a&&a.childNodes&&a.childNodes.length>0){b.appendChild(a.removeChild(a.firstChild));}if(b.firstChild){b.insertBefore(FCK.EditorDocument.createElement("br"),b.firstChild);}c.appendChild(b);this._MarkCells([a],"_Replace");this._ReplaceCellsByMarker(e,"_Replace",c);this._InstallTableMap(e,c.parentNode.parentNode.parentNode);this._MoveCaretToCell(c,false);};FCKTableHandler.HorizontalSplitCell=function(){var s=FCKTableHandler.GetSelectedCells();if(s.length!=1){return;}var c=s[0];var e=this._CreateTableMap(c);var b=c.parentNode.rowIndex;var k=FCKTableHandler._GetCellIndexSpan(e,b,c);var o=isNaN(c.colSpan)?1:c.colSpan;if(o>1){var q=Math.ceil(o/2);var l=FCK.EditorDocument.createElement(c.nodeName);if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(l);}var n=k+q;var d=k+o;var m=isNaN(c.rowSpan)?1:c.rowSpan;for(var a=b;a<b+m;a++){for(var h=n;h<d;h++){e[a][h]=l;}}}else{var f=[];for(var h=0;h<e.length;h++){var p=e[h].slice(0,k);if(e[h].length<=k){f.push(p);continue;}if(e[h][k]==c){p.push(c);p.push(FCK.EditorDocument.createElement(c.nodeName));if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(p[p.length-1]);}}else{p.push(e[h][k]);p.push(e[h][k]);}for(var g=k+1;g<e[h].length;g++){p.push(e[h][g]);}f.push(p);}e=f;}this._InstallTableMap(e,c.parentNode.parentNode.parentNode);};FCKTableHandler.VerticalSplitCell=function(){var q=FCKTableHandler.GetSelectedCells();if(q.length!=1){return;}var m=q[0];var c=this._CreateTableMap(m);var f=m.parentNode.rowIndex;var l=FCKTableHandler._GetCellIndexSpan(c,f,m);var j=isNaN(m.colSpan)?1:m.colSpan;var n=m.rowSpan;if(isNaN(n)){n=1;}if(n>1){m.rowSpan=Math.ceil(n/2);var r=f+Math.ceil(n/2);var a=c[r];var b=null;for(var e=l+1;e<a.length;e++){if(a[e].parentNode.rowIndex==r){b=a[e];break;}}var d=FCK.EditorDocument.createElement(m.nodeName);d.rowSpan=Math.floor(n/2);if(j>1){d.colSpan=j;}if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(d);}m.parentNode.parentNode.parentNode.rows[r].insertBefore(d,b);}else{var o=m.parentNode.sectionRowIndex+1;var p=FCK.EditorDocument.createElement("tr");var h=m.parentNode.parentNode;if(h.rows.length>o){h.insertBefore(p,h.rows[o]);}else{h.appendChild(p);}for(var e=0;e<c[f].length;){var g=c[f][e].colSpan;if(isNaN(g)||g<1){g=1;}if(e==l){e+=g;continue;}var k=c[f][e].rowSpan;if(isNaN(k)){k=1;}c[f][e].rowSpan=k+1;e+=g;}var d=FCK.EditorDocument.createElement(m.nodeName);if(j>1){d.colSpan=j;}if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(d);}p.appendChild(d);}};FCKTableHandler._GetCellIndexSpan=function(f,e,a){if(f.length<e+1){return null;}var b=f[e];for(var d=0;d<b.length;d++){if(b[d]==a){return d;}}return null;};FCKTableHandler._GetCellLocation=function(e,a){for(var b=0;b<e.length;b++){for(var d=0;d<e[b].length;d++){if(e[b][d]==a){return[b,d];}}}return null;};FCKTableHandler._CreateTableMap=function(b){var p=(b.nodeName=="TABLE"?b:b.parentNode.parentNode.parentNode);var o=p.rows;var a=-1;var n=new Array();for(var g=0;g<o.length;g++){a++;if(!n[a]){n[a]=new Array();}var m=-1;for(var f=0;f<o[g].cells.length;f++){var l=o[g].cells[f];m++;while(n[a][m]){m++;}var e=isNaN(l.colSpan)?1:l.colSpan;var h=isNaN(l.rowSpan)?1:l.rowSpan;for(var d=0;d<h;d++){if(!n[a+d]){n[a+d]=new Array();}for(var k=0;k<e;k++){n[a+d][m+k]=o[g].cells[f];}}m+=e-1;}}return n;};FCKTableHandler._InstallTableMap=function(h,g){var f=FCKBrowserInfo.IsIE?"_fckrowspan":"rowSpan";for(var e=0;e<h.length;e++){for(var c=0;c<h[e].length;c++){var a=h[e][c];if(a.parentNode){a.parentNode.removeChild(a);}a.colSpan=a[f]=1;}}var d=0;for(var e=0;e<h.length;e++){for(var c=0;c<h[e].length;c++){var a=h[e][c];if(!a){continue;}if(c>d){d=c;}if(a._colScanned===true){continue;}if(h[e][c-1]==a){a.colSpan++;}if(h[e][c+1]!=a){a._colScanned=true;}}}for(var e=0;e<=d;e++){for(var c=0;c<h.length;c++){if(!h[c]){continue;}var a=h[c][e];if(!a||a._rowScanned===true){continue;}if(h[c-1]&&h[c-1][e]==a){a[f]++;}if(!h[c+1]||h[c+1][e]!=a){a._rowScanned=true;}}}for(var e=0;e<h.length;e++){for(var c=0;c<h[e].length;c++){var a=h[e][c];FCKDomTools.ClearElementJSProperty(a,"_colScanned");FCKDomTools.ClearElementJSProperty(a,"_rowScanned");}}for(var e=0;e<h.length;e++){var b=FCK.EditorDocument.createElement("tr");for(var c=0;c<h[e].length;){var a=h[e][c];if(h[e-1]&&h[e-1][c]==a){c+=a.colSpan;continue;}b.appendChild(a);if(f!="rowSpan"){a.rowSpan=a[f];a.removeAttribute(f);}c+=a.colSpan;if(a.colSpan==1){a.removeAttribute("colspan");}if(a.rowSpan==1){a.removeAttribute("rowspan");}}if(FCKBrowserInfo.IsIE){g.rows[e].replaceNode(b);}else{g.rows[e].innerHTML="";FCKDomTools.MoveChildren(b,g.rows[e]);}}};FCKTableHandler._MoveCaretToCell=function(c,b){var a=new FCKDomRange(FCK.EditorWindow);a.MoveToNodeContents(c);a.Collapse(b);a.Select();};FCKTableHandler.ClearRow=function(c){var a=c.cells;for(var b=0;b<a.length;b++){a[b].innerHTML="";if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(a[b]);}}};FCKTableHandler.GetMergeRightTarget=function(){var i=this.GetSelectedCells();if(i.length!=1){return null;}var c=i[0];var d=this._CreateTableMap(c);var b=c.parentNode.rowIndex;var f=this._GetCellIndexSpan(d,b,c);var g=f+(isNaN(c.colSpan)?1:c.colSpan);var h=d[b][g];if(!h){return null;}this._MarkCells([c,h],"_SizeTest");var e=this._GetMarkerGeometry(d,b,f,"_SizeTest");var a=this._GetMarkerGeometry(d,b,g,"_SizeTest");this._UnmarkCells([c,h],"_SizeTest");if(e.height!=a.height||e.y!=a.y){return null;}return{"refCell":c,"nextCell":h,"tableMap":d};};FCKTableHandler.GetMergeDownTarget=function(){var i=this.GetSelectedCells();if(i.length!=1){return null;}var c=i[0];var d=this._CreateTableMap(c);var b=c.parentNode.rowIndex;var g=this._GetCellIndexSpan(d,b,c);var e=b+(isNaN(c.rowSpan)?1:c.rowSpan);if(!d[e]){return null;}var h=d[e][g];if(!h){return null;}if(c.parentNode.parentNode!=h.parentNode.parentNode){return null;}this._MarkCells([c,h],"_SizeTest");var f=this._GetMarkerGeometry(d,b,g,"_SizeTest");var a=this._GetMarkerGeometry(d,e,g,"_SizeTest");this._UnmarkCells([c,h],"_SizeTest");if(f.width!=a.width||f.x!=a.x){return null;}return{"refCell":c,"nextCell":h,"tableMap":d};};